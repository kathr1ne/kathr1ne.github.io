<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DjangoRESTframework | Kathr1neMinho</title><meta name="keywords" content="Python,Web,前后端分离,RESTful,API"><meta name="author" content="Kathr1neMinho"><meta name="copyright" content="Kathr1neMinho"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RESTFrameworkRESTful API 设计指南 DjangoRESTframework官网 DjangoRESTframework 中文教程 RESTful APIAPI接口： 通过网络 规定了前后台信息交互规则的url链接 也就是前后台信息交互的媒介 简介123456REST 全称：Representational State Transfer 中文意思的表述(通常译为：表征性状态转">
<meta property="og:type" content="article">
<meta property="og:title" content="DjangoRESTframework">
<meta property="og:url" content="https://github.com/kathr1ne/2021/02/22/DjangoRestFramework/index.html">
<meta property="og:site_name" content="Kathr1neMinho">
<meta property="og:description" content="RESTFrameworkRESTful API 设计指南 DjangoRESTframework官网 DjangoRESTframework 中文教程 RESTful APIAPI接口： 通过网络 规定了前后台信息交互规则的url链接 也就是前后台信息交互的媒介 简介123456REST 全称：Representational State Transfer 中文意思的表述(通常译为：表征性状态转">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-02-22T15:00:00.000Z">
<meta property="article:modified_time" content="2021-03-04T05:46:21.554Z">
<meta property="article:author" content="Kathr1neMinho">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="前后端分离">
<meta property="article:tag" content="RESTful">
<meta property="article:tag" content="API">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://github.com/kathr1ne/2021/02/22/DjangoRestFramework/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-04 13:46:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.JPG" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kathr1neMinho</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DjangoRESTframework</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-02-22T15:00:00.000Z" title="发表于 2021-02-22 23:00:00">2021-02-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-04T05:46:21.554Z" title="更新于 2021-03-04 13:46:21">2021-03-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PYTHON/">PYTHON</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="RESTFramework"><a href="#RESTFramework" class="headerlink" title="RESTFramework"></a>RESTFramework</h1><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">RESTful API 设计指南</a></p>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/">DjangoRESTframework官网</a></p>
<p><a target="_blank" rel="noopener" href="https://q1mi.github.io/Django-REST-framework-documentation">DjangoRESTframework 中文教程</a></p>
<h2 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h2><p>API接口： 通过网络 规定了前后台信息交互规则的url链接 也就是前后台信息交互的<strong>媒介</strong></p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REST 全称：Representational State Transfer 中文意思的表述(通常译为：表征性状态转移)</span><br><span class="line"></span><br><span class="line">RESTful是一种定义Web API接口的设计风格 尤其适用于前后端分离的应用模式中</span><br><span class="line">这种风格的理念认为：后端开发任务就是提供数据的 对外提供的是数据资源的访问接口 所以在定义接口时 客户端访问的URL路径就表示这种要操作的数据资源</span><br><span class="line"></span><br><span class="line">事实上 我们可以使用任何一个框架都可以实现符合restful规范的接口</span><br></pre></td></tr></table></figure>
<h3 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h3><p><strong><em>Restful 10条规范</em></strong></p>
<ol>
<li><strong>协议</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL链接一般都采用https协议进行传输 注：采用https协议 可以提高数据交互过程中的安全性</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p><strong>接口特征性表现(一看就知道是API接口)</strong></p>
<p>用api关键字表示接口url</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- https://api.example.com</span><br><span class="line">- https://example.org/api/      </span><br><span class="line"><span class="comment"># 如果确定API很简单 不会有进一步扩展 可以考虑放在主域名之下</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p><strong>多版本共存</strong></p>
<p>应该将API的版本放入URL(一种资源有多版本请况下)</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- https://api.example.com/v1/</span><br><span class="line">- https://api.example.com/v2/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 另一种做法是 将版本号放在HTTP头信息中 但不如放入URL方便和直观</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p><strong>数据即是资源 均使用名字(复数) - 重要</strong></p>
<p>接口一般都是完成前后台数据的交互 交互的数据我们称之为资源</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- https://api.example.com/v1/zoos</span><br><span class="line">- https://api.example.com/v1/animals</span><br><span class="line">- https://api.example.com/v1/employees</span><br><span class="line">    </span><br><span class="line">注：一般提倡用资源的复数形式 在URL链接中不要出现操作资源的动词</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 特殊的接口可以出现动词 因为这些接口一般没有一个明确的资源 或是动词就是接口的核心含义</span></span><br><span class="line">  - https://api.baidu.com/place/search</span><br><span class="line">  - https://api.baidu.com/login</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><p><strong>资源操作由请求方式决定(method) - 重要</strong></p>
<p>操作资源一般都会设计到增删改查 我们提供请求方式来标识这些动作</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- https://api.baidu.com/books  - GET请求：获取所有书</span><br><span class="line">- https://api.baidu.com/books/<span class="number">1</span>  GET请求：获取主键为<span class="number">1</span>的书</span><br><span class="line">- https://api.baidu.com/books    POST请求：新增一本书</span><br><span class="line">- https://api.baidu.com/books/<span class="number">1</span>  PUT请求：整体修改主键为<span class="number">1</span>的书</span><br><span class="line">- https://api.baidu.com/books/<span class="number">1</span>  PATCH请求：局部修改主键为<span class="number">1</span>的书</span><br><span class="line">- https://api.baidu.com/books    DELETE请求：删除主键为<span class="number">1</span>的书</span><br></pre></td></tr></table></figure>
<p>   常用的HTTP动词有下面五个(括号里面是对应的SQL命令)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- GET(SELECT):    从服务器取出资源(一项或多项资源)</span><br><span class="line">- POST(CREATE):   在服务器新建一个资源</span><br><span class="line">- PUT(UPDATE):    在服务器更新资源(客户端提供改变后的完整资源)</span><br><span class="line">- PATCH(UPDATE):  在服务器更新资源(客户端提供改变的属性)</span><br><span class="line">- DELETE(DELETE): 从服务器删除资源</span><br></pre></td></tr></table></figure>
<p>   还有两个不常用的HTTP动词</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- HEAD: 获取资源的元数据</span><br><span class="line">- OPTIONS: 获取信息 关于资源的哪些属性是客户端可以改变的</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><strong>过滤信息</strong></li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果记录数量很多 服务器不可能都将它们返回给用户</span></span><br><span class="line"><span class="comment"># API应该提供参数 过滤返回结果</span></span><br><span class="line">  - ?limit=10   指定返回记录的数量</span><br><span class="line">  - ?offset=10  指定返回记录的开始位置</span><br><span class="line">  - ?page=2&amp;per_page=100  指定第几页，以及每页的记录数</span><br><span class="line">  - ?sortby=name&amp;order=asc  指定返回结果按照哪个属性排序，以及排序顺序</span><br><span class="line">  - ?animal_type_id=1  指定筛选条件</span><br></pre></td></tr></table></figure>
<ol start="7">
<li><p><strong>状态码</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">状态码完全列表</a></p>
<p>服务器向用户返回的状态码和提示信息</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常见的有以下一些(方括号中是该状态码对应的HTTP动词)</span></span><br><span class="line"><span class="number">200</span> OK - [GET]：服务器成功返回用户请求的数据 该操作是幂等的（Idempotent）</span><br><span class="line"><span class="number">201</span> CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功</span><br><span class="line"><span class="number">202</span> Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line"><span class="number">204</span> NO CONTENT - [DELETE]：用户删除数据成功</span><br><span class="line"></span><br><span class="line"><span class="number">301</span> Moved Permanently 永久重定向</span><br><span class="line"><span class="number">302</span> Found 暂时重定向</span><br><span class="line"></span><br><span class="line"><span class="number">400</span> INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误 服务器没有进行新建或修改数据的操作 该操作是幂等的</span><br><span class="line"><span class="number">401</span> Unauthorized - [*]：表示用户没有权限(令牌、用户名、密码错误)</span><br><span class="line"><span class="number">403</span> Forbidden - [*] 表示用户得到授权(与<span class="number">401</span>错误相对) 但是访问是被禁止的</span><br><span class="line"><span class="number">404</span> NOT FOUND - [*]：用户发出的请求针对的是不存在的记录 服务器没有进行操作 该操作是幂等的</span><br><span class="line"><span class="number">406</span> Not Acceptable - [GET]：用户请求的格式不可(比如用户请求JSON格式 但是只有XML格式)</span><br><span class="line"><span class="number">410</span> Gone -[GET]：用户请求的资源被永久删除 且不会再得到的</span><br><span class="line"><span class="number">422</span> Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时 发生一个验证错误</span><br><span class="line"></span><br><span class="line"><span class="number">500</span> INTERNAL SERVER ERROR - [*]：服务器发生错误 用户将无法判断发出的请求是否成功</span><br></pre></td></tr></table></figure>
<ol start="8">
<li><strong>错误处理</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果状态码是4xx 就应该向用户返回出错信息</span></span><br><span class="line"><span class="comment"># 一般来说 返回的信息中将error作为键名 出错信息作为键值即可</span></span><br><span class="line">&#123;</span><br><span class="line">    error: <span class="string">&quot;Invalid API key&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="9">
<li><p><strong>返回结果</strong></p>
<p>针对不同操作 服务器向用户返回的结果应该符合以下规范</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET    /collection： 返回资源对象的列表(数组)</span><br><span class="line">GET    /collection/resource： 返回单个资源对象</span><br><span class="line">POST   /collection： 返回新生成的资源对象</span><br><span class="line">PUT    /collection/resource： 返回完整的资源对象</span><br><span class="line">PATCH  /collection/resource： 返回完整的资源对象</span><br><span class="line">DELETE /collection/resource： 返回一个空文档</span><br></pre></td></tr></table></figure>
<ol start="10">
<li><strong>Hypermedia API</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RESTful API最好做到Hypermedia </span><br><span class="line">即返回结果中提供链接 连向其他API方法 使得用户不查文档 也知道下一步应该做什么</span><br><span class="line"></span><br><span class="line">Hypermedia API的设计被称为HATEOAS</span><br><span class="line">Github的API就是这种设计 访问api.github.com会得到一个所有可用API的网址列表</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;current_user_url&quot;</span>: <span class="string">&quot;https://api.github.com/user&quot;</span>,</span><br><span class="line">  <span class="string">&quot;authorizations_url&quot;</span>: <span class="string">&quot;https://api.github.com/authorizations&quot;</span>,</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>其他</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> API的身份认证应该使用OAuth <span class="number">2.0</span>框架</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 服务器返回的数据格式 应该尽量使用JSON 避免使用XML</span><br></pre></td></tr></table></figure>
<h1 id="DRF初识"><a href="#DRF初识" class="headerlink" title="DRF初识"></a>DRF初识</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework==<span class="number">3.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 在settings.py注册app</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">     ...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 在models.py中写表模型</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    author = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span> 新建一个序列化类</span><br><span class="line"><span class="keyword">from</span> rest_framework.serializers <span class="keyword">import</span> ModelSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelSerializer</span>(<span class="params">ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Book</span><br><span class="line">        fields = <span class="string">&quot;__all__&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="number">4.</span> 在视图中写视图类(CBV)</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializer <span class="keyword">import</span> BookModelSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksViewSet</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span> 写路由关系</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .book <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">&#x27;books&#x27;</span>, views.BooksViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">DRF通过上面几步很少的代码 就已经实现了/books/的5个接口：</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/    GET    获取所有书籍</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/    POST   新增书籍</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/2/  GET    获取主键为2的书籍详情</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/2/  DELETE 删除主键为2的书籍</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/2/  PUT    修改主键为2的书籍详情</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="CBV源码"><a href="#CBV源码" class="headerlink" title="CBV源码"></a>CBV源码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ModelViewSet继承自View(django远程的View)</span></span><br><span class="line"><span class="comment"># ModelViewSet -&gt; APIView -&gt; View</span></span><br></pre></td></tr></table></figure>
<h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><ul>
<li><strong>CBV简单实现</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;books/&#x27;</span>, views.Books.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;c++&#x27;</span>: <span class="number">111</span>&#125;)</span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/  GET  通过CBV实现GET请求方法</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>as_view()</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">源码解读：切入口：as_view()</span></span><br><span class="line"><span class="string">本质还是FBV: </span></span><br><span class="line"><span class="string">    views.Books.as_view() -&gt;  as_view()返回一个函数对象 -&gt; views.Books.view</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">如果请求过来 路径匹配上 会执行 views.Books.view的 view内存地址指向的函数对象 并把request参数传入(当次请求的request对象) -&gt; view(request) </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># as_view()本质</span></span><br><span class="line"><span class="meta">@classonlymethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">cls, **initkwargs</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">        self = cls(**initkwargs)</span><br><span class="line">        <span class="comment"># cls是我们自己写的类 调用的时候自动注入(谁调用 注入谁)</span></span><br><span class="line">        <span class="comment"># self = LoginView(**initkwargs) 产生一个我们自己写的类的实例</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;get&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;head&#x27;</span>):</span><br><span class="line">            self.head = self.get</span><br><span class="line">        self.request = request</span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        以后 经常会需要看源码 但是在看Python源码的时候 一定要时刻提醒自己 面向对象属性方法查找顺序 mro</span></span><br><span class="line"><span class="string">        总结：看源码 只要看到了self.xxx 一定要问自己 当前这个self到底是谁</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line"></span><br><span class="line"><span class="comment"># CBV的精髓 dispath</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="comment"># Try to dispatch to the right method; if a method doesn&#x27;t exist,</span></span><br><span class="line">    <span class="comment"># defer to the error handler. Also defer to the error handler if the</span></span><br><span class="line">    <span class="comment"># request method isn&#x27;t on the approved list.</span></span><br><span class="line">    <span class="comment"># 获取当前请求的小写格式 然后比对当前请求方式是否合法</span></span><br><span class="line">    <span class="comment"># get请求为例</span></span><br><span class="line">    <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">       <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">       反射：通过字符串来操作对象的属性或方法 运行时获取类型定义信息</span></span><br><span class="line"><span class="string">       handler = getattr(自己写的类产生的对象, &#x27;get&#x27;, 当找不到get属性或者方法的时候就会用第三个参数)</span></span><br><span class="line"><span class="string">       handler = 我们自己写的类里面的get方法</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line">        handler = <span class="built_in">getattr</span>(self, request.method.lower(), self.http_method_not_allowed)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        handler = self.http_method_not_allowed</span><br><span class="line">    <span class="comment"># 自动调用get方法</span></span><br><span class="line">    <span class="keyword">return</span> handler(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="APIView"><a href="#APIView" class="headerlink" title="APIView"></a>APIView</h3><ul>
<li><strong>CBV简单实现</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="comment"># 也是as_view() 只不过被APIView(继承View)重写</span></span><br><span class="line">path(<span class="string">&#x27;books_apiview/&#x27;</span>, views.BooksAPIView.as_view())</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksAPIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;APIView&#x27;</span>: <span class="number">666</span>&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>as_view()</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">源码解读：切入口还是 as_view() -&gt; APIView的as_view() -&gt; view 函数内存地址</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">@classmethod  </span><span class="comment"># 类的绑定方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">cls, **initkwargs</span>):</span></span><br><span class="line">    view = <span class="built_in">super</span>().as_view(**initkwargs)  <span class="comment"># 调用父类的as_view方法</span></span><br><span class="line">    view.cls = cls</span><br><span class="line">    view.initkwargs = initkwargs</span><br><span class="line">    <span class="comment"># 继承APIView的视图类会禁用csrf认证(drf会有自己的认证)</span></span><br><span class="line">    <span class="comment"># 添加装饰器的另一种方法 @方式是语法糖 本质就是传入一个被装饰函数给装饰器函数当作实参</span></span><br><span class="line">    <span class="keyword">return</span> csrf_exempt(view)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用csrf装饰器 URL视图还可以这么写 </span></span><br><span class="line">path(<span class="string">&#x27;test/&#x27;</span>, csrf_exempt(as_view))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">发起请求 -&gt; 路由匹配成功 -&gt; view(request) -&gt; 调用dispath() -&gt; mro属性查找顺序 self.dispath会执行到APIView的dispath方法 而不再走View类的dispath -&gt; 把请求方法转为小写 -&gt; 通过反射去对象中查找 有没有改方法定义的属性 有则传入request并执行</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># APIView的disapth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    self.args = args</span><br><span class="line">    self.kwargs = kwargs</span><br><span class="line">    <span class="comment"># request参数是当次请求的request对象</span></span><br><span class="line">    <span class="comment"># 请求过来 wsgi注入一个envrion字段 django把它包装成一个request对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 然后重新赋值的request 是初始化处理后的一个新的Request对象</span></span><br><span class="line">    request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 现在视图函数拿到的request 已经不是django原生给我们封装的request</span></span><br><span class="line">    <span class="comment"># 而是drf自己定义的request对象(mro) 以后视图函数再使用的request对象 就是这个新的drf定义的对象</span></span><br><span class="line">    self.request = request  <span class="comment"># 将新的request对象赋值给self.request 你视图函数里面 其他的方法 也可以从这个里面获取相关数据</span></span><br><span class="line">    self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 三大认证模块</span></span><br><span class="line">        self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">        <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">            handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                              self.http_method_not_allowed)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            handler = self.http_method_not_allowed</span><br><span class="line">		 <span class="comment"># 响应模块</span></span><br><span class="line">        response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">       <span class="comment"># 异常模块</span></span><br><span class="line">        response = self.handle_exception(exc)</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 渲染模块</span></span><br><span class="line">    self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> self.response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 封装drf自己的request对象</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    parser_context = self.get_parser_context(request)</span><br><span class="line">    <span class="comment"># django原来的request 被封装到Request里面 </span></span><br><span class="line">    <span class="comment"># self._request 原生的request</span></span><br><span class="line">    <span class="comment"># self.request  drf封装的request</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回DRF封装的Request类实例化之后的对象</span></span><br><span class="line">    <span class="keyword">return</span> Request(</span><br><span class="line">        request,    <span class="comment"># 原生的request对象</span></span><br><span class="line">        <span class="comment"># 获取解析类</span></span><br><span class="line">        parsers=self.get_parsers(),</span><br><span class="line">        authenticators=self.get_authenticators(),</span><br><span class="line">        negotiator=self.get_content_negotiator(),</span><br><span class="line">        parser_context=parser_context</span><br><span class="line">    ) </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">针对这个赋值：</span></span><br><span class="line"><span class="string">self.request = request  # 将新的request对象赋值给self.request 你视图函数里面 其他的方法 也可以从这个里面获取相关数据(就是drf封装的当次请求的request)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class MyCBV(VPIView):</span></span><br><span class="line"><span class="string">	def get(self, request):</span></span><br><span class="line"><span class="string">	    ..</span></span><br><span class="line"><span class="string">	def foo(self):</span></span><br><span class="line"><span class="string">	    print(self.request)  # 视图函数中 其他方法 不用传参 也可以直接使用该对象     </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Request</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">from rest_framework.request import Request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">只要继承了APIView 视图类中的request对象 都是新的</span></span><br><span class="line"><span class="string">也就是上面导入路径这个Request的对象(实例)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">使用使用新的request对象 就像使用之前的request是一模一样的(因为重写了__getattr__方法)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def __getattr__(self, attr):</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        return getattr(self._request, attr)</span></span><br><span class="line"><span class="string">    except AttributeError:</span></span><br><span class="line"><span class="string">        return self.__getattribute__(attr)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Wrapper allowing to enhance a standard `HttpRequest` instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Kwargs:</span></span><br><span class="line"><span class="string">        - request(HttpRequest). The original request instance.</span></span><br><span class="line"><span class="string">        - parsers(list/tuple). The parsers to use for parsing the</span></span><br><span class="line"><span class="string">          request content.</span></span><br><span class="line"><span class="string">        - authenticators(list/tuple). The authenticators used to try</span></span><br><span class="line"><span class="string">          authenticating the request&#x27;s user.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, request, parsers=<span class="literal">None</span>, authenticators=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=<span class="literal">None</span>, parser_context=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(request, HttpRequest), (</span><br><span class="line">            <span class="string">&#x27;The `request` argument must be an instance of &#x27;</span></span><br><span class="line">            <span class="string">&#x27;`django.http.HttpRequest`, not `&#123;&#125;.&#123;&#125;`.&#x27;</span></span><br><span class="line">            .<span class="built_in">format</span>(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># self._request 原生的request</span></span><br><span class="line">        self._request = request</span><br><span class="line">        self._data = Empty</span><br><span class="line">		...</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># restframework封装的request对象</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">django封装的request对象没有.data &#123;&#125;</span></span><br><span class="line"><span class="string">它是一个字典 </span></span><br><span class="line"><span class="string">  - post请求不管使用什么编码(form/urlencoded/json) 传过来的数据 都在request.data</span></span><br><span class="line"><span class="string">  - get请求</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">request.data    </span><br></pre></td></tr></table></figure>
<ul>
<li><strong>取POST请求数据</strong></li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>django原生request(request.POST)</th>
<th>drf封装后的Request对象(request.data)</th>
</tr>
</thead>
<tbody><tr>
<td>form</td>
<td>有数据 QueryDict</td>
<td>有数据 QueryDict</td>
</tr>
<tr>
<td>urlencoded</td>
<td>有数据 QueryDict</td>
<td>有数据 QueryDict</td>
</tr>
<tr>
<td>json</td>
<td>无数据</td>
<td>有数据 普通字典</td>
</tr>
</tbody></table>
<ul>
<li><strong>取GET请求url中的数据</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf Request类方法</span></span><br><span class="line"><span class="comment"># self._request.GET = request.query_params</span></span><br><span class="line"><span class="comment"># django原来取： request.GET</span></span><br><span class="line"><span class="comment"># drf取： request.query_params</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_params</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self._request.GET</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>APIView的initial方法</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dispath中调用 initial方法</span></span><br><span class="line"><span class="comment"># request参数 已经是新的request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">	...</span><br><span class="line">    <span class="comment"># Ensure that the incoming request is permitted</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    perform_authentication</span></span><br><span class="line"><span class="string">    认证组件：检验用户 - 游客、合法用户、非法用户</span></span><br><span class="line"><span class="string">      游客： 代表检验通过 直接进入下一步校验(权限检验)</span></span><br><span class="line"><span class="string">      合法用户：代表校验通过 将用户存储再request.user中 再进入下一步校验(权限校验)</span></span><br><span class="line"><span class="string">      非法用户：代表校验失败 抛出异常 返回403权限异常结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.perform_authentication(request)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    check_permissions</span></span><br><span class="line"><span class="string">    权限组件：校验用户权限 - 必须登录、所有用户、登录读写游客只读、自定义用户角色</span></span><br><span class="line"><span class="string">      认证通过：可以进入下一步校验(频率认证)</span></span><br><span class="line"><span class="string">      认证失败：抛出异常 返回403权限异常结构</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.check_permissions(request)</span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    check_throttles</span></span><br><span class="line"><span class="string">    频率组件：限制视图接口被访问的频率次数 - 限制的条件(IP/id/唯一键)、频率周期时间(s/m/h)、频率的次数(3/s)</span></span><br><span class="line"><span class="string">    没有达到限制：正常访问接口</span></span><br><span class="line"><span class="string">    达到限制：限制时间之内不能访问 限制时间达到后 可以重新访问</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.check_throttles(request)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>补充</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于Python中一切皆对象 所以都可以设置属性 取出属性</span></span><br><span class="line"><span class="comment"># Python源码中使用非常多</span></span><br><span class="line">add.xyz = <span class="string">&#x27;xyz111&#x27;</span>  </span><br><span class="line"></span><br><span class="line">print(add(<span class="number">5</span>, <span class="number">5</span>))</span><br><span class="line">print(add.xyz)</span><br></pre></td></tr></table></figure>
<h1 id="序列化器"><a href="#序列化器" class="headerlink" title="序列化器"></a>序列化器</h1><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/serializers/">drf-Serializer</a></p>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/fields/">drf-Serializer-fileds</a></p>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/relations/">drf-Serializer-relations</a></p>
<p> <strong>Serializer</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">序列化：序列化器会把模型对象转换为字典 经过response以后变成json字符串 </span></span><br><span class="line"><span class="string">       model对象 -&gt; json</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">反序列化：把客户端发送过来的数据 经过request以后变成字典(框架封装) 序列化器可以把字典转成模型</span></span><br><span class="line"><span class="string">       json -&gt; model对象</span></span><br><span class="line"><span class="string">       反序列化另一个作用：完成数据的校验功能(类似forms组件)  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Serializer类 必须写一个类继承它 想序列化什么字段就在里面写字段(source可以修改序列化出来的字段名 获取取属性 .跨表)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 序列化queryset(列表)对象和真正(单个)的对象 many=<span class="literal">True</span>的作用 instance=要序列化的对象(模型类对象 也就是模型类实例)</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 反序列化 instance=要序列化的对象 data=request.data(新增没有instance参数)</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 字段验证 序列化类中 给字段加属性(字段参数) 局部和全局钩子函数|字段参数的validaores=[] </span><br><span class="line">   视图函数中调用 序列化对象.is_valid(raise_exception=<span class="literal">True</span>)进行验证 raise_exception参数默认<span class="literal">False</span> 如果为<span class="literal">True</span> 验证不通过直接抛出异常</span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span> 反序列化数据保存</span><br><span class="line">   5.1 修改保存 -&gt; 调用序列化对象的.save() -&gt; 触发序列化类的.update方法</span><br><span class="line">   5.2 新增保存 -&gt; 调用序列化对象的.save() -&gt; 触发序列化类的.create方法</span><br><span class="line"></span><br><span class="line">   备注：</span><br><span class="line">   如果自定义序列化类不是继承的ModelSerializer 需要重写 .update方法和.create方法(可以很复杂)</span><br><span class="line">   如果反序列的数据中有需要保存到第三张表的 需要在重写的方法额外处理</span><br><span class="line">    </span><br><span class="line"><span class="number">6.</span> ModelSerializer 跟Model做了对应 写法固定 字段参数直接用 extra_kwargs</span><br><span class="line">   其余用法和继承Serializer一摸一样(包括全局/局部钩子函数)</span><br><span class="line">    </span><br><span class="line"><span class="number">7.</span> many=<span class="literal">True</span> 可以序列化多条的原因</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> 接口 鸭子类型</span><br><span class="line">           </span><br></pre></td></tr></table></figure>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><h3 id="查询一个数据"><a href="#查询一个数据" class="headerlink" title="查询一个数据"></a>查询一个数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">GET 127.0.0.1:8000/books/1 获取书籍id为1的书籍信息</span></span><br><span class="line"><span class="string">  1. 写一个序列化的类 继承Serializer类</span></span><br><span class="line"><span class="string">  2. 在类中写想要序列化的字段 想序列化哪个字段 就在类中写哪个字段</span></span><br><span class="line"><span class="string">  3. 在视图类中使用 导入自定义序列化类 -&gt; 实例化得到的序列化类对象(把要序列化的对象传入)</span></span><br><span class="line"><span class="string">  4. 序列化类的对象.data 是一个字典</span></span><br><span class="line"><span class="string">  5. 把字典返回 如果不使用rest_framework提供的Response 就得使用JsonResponse</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;books/&lt;int:pk&gt;&#x27;</span>, views.BooksDetailView.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># serializers.py</span></span><br><span class="line"><span class="comment"># from rest_framework.serializers import Serializer</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;想要序列化的字段 不需要直接注释即可&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    name = serializers.CharField()</span><br><span class="line">    price = serializers.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    author = serializers.CharField()</span><br><span class="line">    publish = serializers.CharField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetailView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="comment"># 获取数据对象</span></span><br><span class="line">        book = Book.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        <span class="comment"># 用一个类 毫无疑问：实例化 </span></span><br><span class="line">        <span class="comment"># instance参数关键字传参或者第一个位置位置传参(源码) -&gt; 序列化</span></span><br><span class="line">        serializer = BookSerializer(instance=book)</span><br><span class="line">        <span class="comment"># serializer.data -&gt; 序列化后的字典</span></span><br><span class="line">        print(serializer.data)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Response</span></span><br><span class="line"><span class="string">          使用drf Response返回 需要在settings.py注册rest_framework</span></span><br><span class="line"><span class="string">        Response会判断访问来源(user-agent) 来返回 渲染好的网页 或者是 json数据</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        JsonResponse</span></span><br><span class="line"><span class="string">          无需再注册rest_framework</span></span><br><span class="line"><span class="string">          只会返回json数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="comment"># return JsonResponse(serializer.data)</span></span><br></pre></td></tr></table></figure>
<h3 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h3><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/fields/">SerializerFields</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/lxraw/lxraw-u4kq35ot.html">序列化器字段</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整字段见上面参考链接</span></span><br><span class="line">CharField</span><br><span class="line">IntergerField</span><br><span class="line">DateField</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="字段参数"><a href="#字段参数" class="headerlink" title="字段参数"></a>字段参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检验功能 非常类似forms组件</span></span><br><span class="line">  <span class="number">1.</span> 自带字段选项校验(更多参考字段链接详细内容)</span><br><span class="line">     - read_only</span><br><span class="line">     - required  默认为<span class="literal">True</span></span><br><span class="line">     - max_length </span><br><span class="line">     - validators</span><br><span class="line">         验证器功能列表 应将其应用于输入字段输入 并引发验证错误或简单地返回</span><br><span class="line">       ...        </span><br><span class="line">  <span class="number">2.</span> 局部钩子函数</span><br><span class="line">  <span class="number">3.</span> 全局钩子函数</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 通用字段参数</span></span><br><span class="line">read_only        表明该字段仅用于序列化输出 默认<span class="literal">False</span></span><br><span class="line">write_only       表明该字段仅用于反序列化输入 默认<span class="literal">False</span></span><br><span class="line">required         表明该字段在反序列化时必须输入 默认<span class="literal">True</span></span><br><span class="line">default          反序列化时使用的默认值</span><br><span class="line">allow_null       表明该字段是否允许传入<span class="literal">None</span> 默认Flase</span><br><span class="line">validators       该字段使用的验证器</span><br><span class="line">error_messages   包含错误编号与错误信息的字典</span><br><span class="line">label            用于HTML展示API页面时 显示的字段名称</span><br><span class="line">help_text        用于HTML展示API页面时 显示的字段帮助提示信息</span><br></pre></td></tr></table></figure>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><h3 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">PUT 127.0.0.1:8000/books/1 修改书籍主键为1的书籍信息</span></span><br><span class="line"><span class="string">  1. 写一个序列化的类 继承Serializer类</span></span><br><span class="line"><span class="string">  2. 在类中写想要反序列化的字段</span></span><br><span class="line"><span class="string">  3. 在视图类中使用 导入自定义序列化类 -&gt; 实例化得到的序列化类对象(把要修改的对象 和 修改的数据传入)</span></span><br><span class="line"><span class="string">      # instance=要修改的对象</span></span><br><span class="line"><span class="string">      # data=修改的数据</span></span><br><span class="line"><span class="string">      serializer = BookSerializer(instance=book, data=request.data)</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">   4. 数据校验</span></span><br><span class="line"><span class="string">      # raise_exception参数默认为False</span></span><br><span class="line"><span class="string">      # 如果为True 验证不通过直接抛出异常</span></span><br><span class="line"><span class="string">      serializer.is_valid(raise_exception=True)</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      4.1 如果校验通过 就保存</span></span><br><span class="line"><span class="string">          serializer.save()  # 是序列化器的save()方法</span></span><br><span class="line"><span class="string">      4.2 如果校验不通过</span></span><br><span class="line"><span class="string">          返回错误信息</span></span><br><span class="line"><span class="string">          </span></span><br><span class="line"><span class="string">   5. 如果字段的校验规则不够 可以自己写钩子函数(局部和全局 类似forms)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetailView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        response_msg = &#123;<span class="string">&#x27;status&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;成功&#x27;</span>&#125;</span><br><span class="line">        <span class="comment"># 找到这个对象</span></span><br><span class="line">        book = Book.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        <span class="comment"># 直接用request.data的数据来修改原来的对象 -&gt; 反序列化</span></span><br><span class="line">        serializer = BookSerializer(book, request.data)</span><br><span class="line">        <span class="comment"># 一定要数据验证(类似form表单验证)</span></span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            <span class="comment"># 直接调用报错 需要重写update方法 接口规范了子类的行为 鸭子类型</span></span><br><span class="line">            <span class="comment"># NotImplementedError: `update()` must be implemented.</span></span><br><span class="line">            serializer.save()  <span class="comment"># 验证通过则返回</span></span><br><span class="line">            response_msg[<span class="string">&#x27;data&#x27;</span>] = serializer.data</span><br><span class="line">            <span class="comment"># return Response(serializer.data)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response_msg[<span class="string">&#x27;status&#x27;</span>] = <span class="number">1001</span></span><br><span class="line">            response_msg[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;数据校验失败&#x27;</span></span><br><span class="line">            response_msg[<span class="string">&#x27;data&#x27;</span>] = serializer.errors</span><br><span class="line">        <span class="keyword">return</span> Response(response_msg)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 直接继承Serializer没有update方法 需要重写</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    name = serializers.CharField(max_length=<span class="number">16</span>, min_length=<span class="number">4</span>)</span><br><span class="line">    price = serializers.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    author = serializers.CharField()</span><br><span class="line">    publish = serializers.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="comment"># instance是book这个对象</span></span><br><span class="line">        <span class="comment"># validated_data是校验后的数据</span></span><br><span class="line">        instance.name = validated_data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        instance.price = validated_data.get(<span class="string">&#x27;price&#x27;</span>)</span><br><span class="line">        instance.author = validated_data.get(<span class="string">&#x27;author&#x27;</span>)</span><br><span class="line">        instance.publish = validated_data.get(<span class="string">&#x27;publish&#x27;</span>)</span><br><span class="line">        instance.save()  <span class="comment"># django ORM提供的</span></span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
<h3 id="数据校验钩子函数"><a href="#数据校验钩子函数" class="headerlink" title="数据校验钩子函数"></a>数据校验钩子函数</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">先自己字段参数验证 </span><br><span class="line">-&gt; 如果该字段有局部钩子函数 走该函数验证该字段</span><br><span class="line">-&gt; 所有字段按照该顺序验证完成 看是否有全局钩子验证函数</span><br><span class="line">-&gt; 全局钩子函数验证(此时数据已经经过第一次校验 validated_data)</span><br><span class="line">-&gt; 验证完成</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>局部钩子</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_price</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        validate_字段名(通过反射获取该方法) 接收一个参数</span></span><br><span class="line"><span class="string">        :param data: 就是price 可以对任意单一字段自定义校验</span></span><br><span class="line"><span class="string">        :return: data</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="comment"># print(type(data))</span></span><br><span class="line">        <span class="keyword">if</span> data &gt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="comment"># 校验失败 抛出异常</span></span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;价格太低&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">1001</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;数据校验失败&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;价格太低&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>全局钩子</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        全局钩子：校验多个字段</span></span><br><span class="line"><span class="string">        :param attrs: 校验通过的数据(validated_data)</span></span><br><span class="line"><span class="string">        :return: attrs </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        print(attrs)</span><br><span class="line">        author = attrs.get(<span class="string">&#x27;author&#x27;</span>)</span><br><span class="line">        publish = attrs.get(<span class="string">&#x27;publish&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> author == publish:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;作者名字和出版社一致&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">1001</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;数据校验失败&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;non_field_errors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;作者名字和出版社一致&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数validators(非钩子函数 字段选项验证器 较少使用)</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_author</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> data.startswith(<span class="string">&#x27;sb&#x27;</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;作者名字不能以sb开头&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 使用字段参数：验证器</span></span><br><span class="line">    author = serializers.CharField(validators=[check_author])</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">加上上面的钩子函数和自带的字段验证 总共有三种验证数据的方式：</span></span><br><span class="line"><span class="string">  1. 字段参数自带的验证参数们</span></span><br><span class="line"><span class="string">  2. 局部钩子/全局钩子函数</span></span><br><span class="line"><span class="string">  3. 参数：validators 验证器</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">抛出无效数据的异常</span></span><br><span class="line"><span class="string">  .is_valid()方法使用可选的raise_exception标志 如果存在验证错误将会抛出一个serializers.ValidationError异常</span></span><br><span class="line"><span class="string">  这些异常由REST framework提供的默认异常处理程序自动处理 </span></span><br><span class="line"><span class="string">  默认情况下将返回HTTP 400 Bad Request响应</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果数据无效就返回400响应</span></span><br><span class="line">serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;数据校验失败&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;author&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;作者名字不能以sb开头&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="序列化反序列化字段处理"><a href="#序列化反序列化字段处理" class="headerlink" title="序列化反序列化字段处理"></a>序列化反序列化字段处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">问题：我们序列化的时候和反序列化的时候 使用的字段数目不全部一致</span></span><br><span class="line"><span class="string">     比如主键id 序列化展示 反序列化不应该输入</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解决：</span></span><br><span class="line"><span class="string">  1. 写两个serializer类 一个用于序列化 一个用于反序列化 -&gt; 冗余度非常高 麻烦</span></span><br><span class="line"><span class="string">  2. 字段参数解决</span></span><br><span class="line"><span class="string">      read_only    表明该字段仅用于序列化输出 默认False</span></span><br><span class="line"><span class="string">      write_only   表名该字段仅用于反序列化输入 默认False</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    read_only=True</span></span><br><span class="line"><span class="string">      - 序列化输出 有该字段</span></span><br><span class="line"><span class="string">      - 反序列化传入数据 不需要传该字段 错误的输入所有的read_only字段都将被忽略</span></span><br><span class="line"><span class="string">    write_only</span></span><br><span class="line"><span class="string">      - 序列化输出 没有该字段</span></span><br><span class="line"><span class="string">      - 反序列化传入数据 必须传入该字段 否则校验失败</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    publish = serializers.CharField(max_length=<span class="number">64</span>, min_length=<span class="number">2</span>, write_only=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="其余API操作"><a href="#其余API操作" class="headerlink" title="其余API操作"></a>其余API操作</h2><h3 id="查询所有数据"><a href="#查询所有数据" class="headerlink" title="查询所有数据"></a>查询所有数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line">path(<span class="string">&#x27;books/&#x27;</span>, views.Books.as_view())</span><br><span class="line"></span><br><span class="line"><span class="comment"># View</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        books = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 序列化多条 需要加参数：many=True</span></span><br><span class="line">        serializer = BookModelSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<h3 id="新增数据"><a href="#新增数据" class="headerlink" title="新增数据"></a>新增数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line">path(<span class="string">&#x27;books/&#x27;</span>, views.Books.as_view())</span><br><span class="line"></span><br><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, repost</span>):</span></span><br><span class="line">        <span class="comment"># 修改才有instance 新增没有instance 只有data</span></span><br><span class="line">        <span class="comment"># 必须关键字传参 位置传参会给到第一个位置参数:instance</span></span><br><span class="line">        book_ser = BookModelSerializer(data=repost.data)</span><br><span class="line">        <span class="comment"># 校验字段</span></span><br><span class="line">        <span class="keyword">if</span> book_ser.is_valid():</span><br><span class="line">            book_ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(book_ser.data)</span><br><span class="line">        <span class="keyword">return</span> Response(book_ser.errors)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># serializers.py 需要重写create()方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param validated_data: dict正好可以**解构</span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 如果validated_data的数据 不是全部需要 </span></span><br><span class="line">        <span class="comment"># 就需要拿出来额外处理 不能直接双**解构</span></span><br><span class="line">        <span class="keyword">return</span> Book.objects.create(**validated_data)</span><br></pre></td></tr></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除无需序列化器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetail</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;删除一个数据&quot;&quot;&quot;</span></span><br><span class="line">        Book.objects.<span class="built_in">filter</span>(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure>
<h2 id="自定义响应内容"><a href="#自定义响应内容" class="headerlink" title="自定义响应内容"></a>自定义响应内容</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyResponse</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.status = <span class="number">100</span></span><br><span class="line">        self.mgs = <span class="string">&#x27;success&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__dict__</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用的时候 实例化再修改属性即可</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    res = MyResponse()</span><br><span class="line">    res.status = <span class="number">101</span></span><br><span class="line">    res.msg = <span class="string">&#x27;数据校验失败&#x27;</span></span><br><span class="line">    res.data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Minho&#x27;</span>&#125;</span><br><span class="line">    print(res.get_dict)</span><br></pre></td></tr></table></figure>
<h2 id="模型类序列化器"><a href="#模型类序列化器" class="headerlink" title="模型类序列化器"></a>模型类序列化器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># ModelSerializer 也可以使用source参数 用法一样</span></span><br><span class="line">    pce = serializers.CharField(source=<span class="string">&#x27;publish.price&#x27;</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Book                  <span class="comment"># 对应models.py中的表模型(要序列化哪个表的数据)</span></span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;          # __all__标识序列化所有字段</span></span><br><span class="line">        <span class="comment"># fields = [&#x27;name&#x27;, &#x27;price&#x27;]  # 只序列化指定字段</span></span><br><span class="line">        exclude = [<span class="string">&#x27;name&#x27;</span>]            <span class="comment"># 跟fields不能都写 写哪个字段标识排除哪个字段</span></span><br><span class="line">        read_only_fields = [<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">        extra_kwargs = &#123;</span><br><span class="line">            <span class="string">&#x27;author&#x27;</span>: &#123;<span class="string">&#x27;write_only&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">write_only_fields 弃用 -&gt; 使用extra_kwargs解决</span></span><br><span class="line"><span class="string">  可以通过使用extra_kwargs选项快捷地在字段上指定任意附加的关键字参数</span></span><br><span class="line"><span class="string">  类似于：Serializer的 name = serializers.CharField(max_length=16, min_length=4)</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">示例：</span></span><br><span class="line"><span class="string">  extra_kwargs = &#123;&#x27;password&#x27;: &#123;&#x27;write_only&#x27;: True&#125;,</span></span><br><span class="line"><span class="string">                  &#x27;author&#x27;: &#123;&#x27;write_only&#x27;: True&#125;,&#125;</span></span><br><span class="line"><span class="string">                  </span></span><br><span class="line"><span class="string">备注：</span></span><br><span class="line"><span class="string">  继承ModelSerializer之后 不用再自己重写 .update() 和 .create()方法</span></span><br><span class="line"><span class="string">  其他使用方式和继承Serializer 一摸一样</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>        </span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;nid&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;pce&quot;</span>: <span class="string">&quot;129.11&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;红楼梦&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;129.11&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;publish&quot;</span>: <span class="string">&quot;北京出版社&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;nid&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;pce&quot;</span>: <span class="string">&quot;192.45&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;python&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;192.45&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;publish&quot;</span>: <span class="string">&quot;xx出版社&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="many-True源码分析"><a href="#many-True源码分析" class="headerlink" title="many=True源码分析"></a>many=True源码分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 序列化多条数据的时候 需要传 many=True</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 序列化单条</span></span><br><span class="line">        book = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        books_one_ser = BookModelSerializer(instance=book)</span><br><span class="line">        <span class="comment"># 序列化多条</span></span><br><span class="line">        books = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        books_ser = BookModelSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        print(<span class="built_in">type</span>(books_one_ser))</span><br><span class="line">        print(<span class="built_in">type</span>(books_ser))</span><br><span class="line">        <span class="keyword">return</span> Response(books_ser.data)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># many=True时 返回的结果跟不传 不是同一个类的对象</span></span><br><span class="line">单条类型： &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">drftutorial</span>.<span class="title">book</span>.<span class="title">serializer</span>.<span class="title">BookModelSerializer</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">多条类型： &lt;<span class="title">class</span> &#x27;<span class="title">rest_framework</span>.<span class="title">serializers</span>.<span class="title">ListSerializer</span>&#x27;&gt; </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class">对象的生成：先调用类的<span class="title">__new__</span>方法 生成空对象</span></span><br><span class="line"><span class="class">实例化：类名(<span class="params">参数</span>) 调用类的<span class="title">__init__</span>()方法</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">类的<span class="title">__new__</span>方法 控制对象的生成 -&gt; 由此猜测BookModelSerializer类的__new__方法做了处理 根据是否有many=True参数 生成不同的类对象</span></span><br><span class="line"><span class="class">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class">class BaseSerializer(Field):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># We override this method in order to automatically create</span></span><br><span class="line">        <span class="comment"># `ListSerializer` classes instead when `many=True` is set.</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.pop(<span class="string">&#x27;many&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">return</span> cls.many_init(*args, **kwargs)</span><br><span class="line">        <span class="comment"># 没有传many=True 正常实例化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, *args, **kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">many_init</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">		...</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        如果传入many=True 调用该方法 生成新得类对象 里面就是一个个得Serializer对象</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> list_serializer_class(*args, **list_kwargs)</span><br></pre></td></tr></table></figure>
<h2 id="Serializer高级用法"><a href="#Serializer高级用法" class="headerlink" title="Serializer高级用法"></a>Serializer高级用法</h2><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/relations/">关联字段</a></p>
<h3 id="一对多关系字段"><a href="#一对多关系字段" class="headerlink" title="一对多关系字段"></a>一对多关系字段</h3><ul>
<li><strong>source参数</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">source参数就是指定序列化对象的属性</span><br><span class="line">该属性可以是模型类的字段属性</span><br><span class="line">也可以是该模型类的方法(类方法本质也是类属性 本质一样）</span><br><span class="line">            </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">source的使用 下面三个功能：</span></span><br><span class="line"><span class="string">  1. 可以改字段名字  xxx = serializers.CharField(max_length=32, source=&#x27;title&#x27;)</span></span><br><span class="line"><span class="string">  2. 可以.跨表取属性 publish = serializers.CharField(source=&#x27;publish.email&#x27;)</span></span><br><span class="line"><span class="string">  3. 可以执行方法 publish_date = serializers.DateTimeField(source=&#x27;test&#x27;)  # test不是model类对应字段 而是自定义函数</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>source=对象属性</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">一对多关系字段：</span></span><br><span class="line"><span class="string">  1. 模型类__str__魔术方法</span></span><br><span class="line"><span class="string">     publish = serializers.CharField() -&gt; book.publish -&gt; 获取publish的__str__方法返回值</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  2. source参数用法</span></span><br><span class="line"><span class="string">     publish = serializers.CharField(source=&#x27;publish.email&#x27;)</span></span><br><span class="line"><span class="string">     source参数可以直接取模型类的字段</span></span><br><span class="line"><span class="string">       2.1 更换序列化器显示的字段名称(隐藏真正的数据库字段) 用source与实际的数据库模块字段对应 </span></span><br><span class="line"><span class="string">       xxx = serializers.CharField(max_length=32, source=&#x27;title&#x27;)       </span></span><br><span class="line"><span class="string">       2.2 一对多关系中 可以取到关联关系表中的其他字段(跨表)</span></span><br><span class="line"><span class="string">       publish = serializers.CharField(source=&#x27;publish.email&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="comment"># 这部分字段相当于隐藏了模型前缀 相当于取book得属性(包括方法)</span></span><br><span class="line">    <span class="comment"># book.xxx | book.price | book.publish_data...</span></span><br><span class="line">    xxx = serializers.CharField(max_length=<span class="number">32</span>, source=<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">    price = serializers.DecimalField(max_digits=<span class="number">8</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    publish_date = serializers.DateTimeField()</span><br><span class="line">    <span class="comment"># book.publish 外键关联字段 直接写 显示结果会显示__str__方法的结果</span></span><br><span class="line">    publish = serializers.CharField(source=<span class="string">&#x27;publish.email&#x27;</span>)</span><br><span class="line">    <span class="comment"># book.authors None -&gt; book.authors.all()   </span></span><br></pre></td></tr></table></figure>
<p><strong>source=对象方法</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># serializers.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    xxx = serializers.CharField(max_length=<span class="number">32</span>, source=<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">    publish_date = serializers.DateTimeField(source=<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;book.test method&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">source指定的方法的return内容就是序列化的内容</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;xxx&quot;</span>: <span class="string">&quot;红楼梦&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;publish_date&quot;</span>: <span class="string">&quot;book.test method&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多对多关系字段"><a href="#多对多关系字段" class="headerlink" title="多对多关系字段"></a>多对多关系字段</h3><ul>
<li><strong>SerializerMethodField</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	...</span><br><span class="line">    authors = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authors</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment"># obj: book对象</span></span><br><span class="line">        authors = obj.authors.<span class="built_in">all</span>()  <span class="comment"># 跨表拿出所有作者</span></span><br><span class="line">        <span class="keyword">return</span> [&#123;<span class="string">&#x27;name&#x27;</span>: author.name, <span class="string">&#x27;age&#x27;</span>: author.age&#125; <span class="keyword">for</span> author <span class="keyword">in</span> authors]</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">serializer通过字段取出多对多关系表数据：</span></span><br><span class="line"><span class="string">  SerializerMethodField(method_name=None)</span></span><br><span class="line"><span class="string">  这是一个只读字段 它通过在附加的序列化器类上调用一个方法来获取其值 它可以用于将任何类型的数据添加到对象的序列化表示中</span></span><br><span class="line"><span class="string">  该字段会绑定一个方法 如果没有指定method_name  则默认为：get_&lt;field_name&gt;(self, obj): pass</span></span><br><span class="line"><span class="string">  该方法返回什么 序列化的字段就显示什么内容</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;xxx&quot;</span>: <span class="string">&quot;红楼梦&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="string">&quot;123.45&quot;</span>,</span><br><span class="line">    <span class="string">&quot;publish_date&quot;</span>: <span class="string">&quot;2021-01-05T20:43:26Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;publish&quot;</span>: <span class="string">&quot;南京出版社&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authors&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;minho&quot;</span>,</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: <span class="number">25</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;kimi&quot;</span>,</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: <span class="number">46</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="请求与响应"><a href="#请求与响应" class="headerlink" title="请求与响应"></a>请求与响应</h1><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP">MDN HTTP教程</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.1/ref/request-response/">django request-response</a></p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/requests/">drf-request</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/python3/python3-assert.html">assert断言 补充</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Rqeust类并没有继承django的</span></span><br><span class="line"><span class="comment"># CBV源码有部分解析</span></span><br><span class="line"><span class="comment"># 位置：from rest_framework.request import Request</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Request部分关键源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Wrapper allowing to enhance a standard `HttpRequest` instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Kwargs:</span></span><br><span class="line"><span class="string">        - request(HttpRequest). The original request instance.</span></span><br><span class="line"><span class="string">        - parsers(list/tuple). The parsers to use for parsing the</span></span><br><span class="line"><span class="string">          request content.</span></span><br><span class="line"><span class="string">        - authenticators(list/tuple). The authenticators used to try</span></span><br><span class="line"><span class="string">          authenticating the request&#x27;s user.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, request, parsers=<span class="literal">None</span>, authenticators=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=<span class="literal">None</span>, parser_context=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(request, HttpRequest), (</span><br><span class="line">            <span class="string">&#x27;The `request` argument must be an instance of &#x27;</span></span><br><span class="line">            <span class="string">&#x27;`django.http.HttpRequest`, not `&#123;&#125;.&#123;&#125;`.&#x27;</span></span><br><span class="line">            .<span class="built_in">format</span>(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 赋值django封装的request</span></span><br><span class="line">        self._request = request</span><br><span class="line">      </span><br><span class="line">    <span class="comment"># 获取属性处理</span></span><br><span class="line">    <span class="comment"># 如果自己没有的 问django原生封装的request要 这个时候是self._request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, attr</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        If an attribute does not exist on this instance, then we also attempt</span></span><br><span class="line"><span class="string">        to proxy it to the underlying HttpRequest object.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(self._request, attr)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">return</span> self.__getattribute__(attr)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># request.data</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _hasattr(self, <span class="string">&#x27;_full_data&#x27;</span>):</span><br><span class="line">            self._load_data_and_files()</span><br><span class="line">        <span class="keyword">return</span> self._full_data</span><br><span class="line">        </span><br><span class="line"><span class="comment"># __getattribute__</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span>(<span class="params">self, *args, **kwargs</span>):</span> <span class="comment"># real signature unknown</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Return getattr(self, name). &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="request-data"><a href="#request-data" class="headerlink" title="request.data"></a><strong>request.data</strong></h3><p><strong>取POST请求数据</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">请求对象.data -&gt; request.data</span><br><span class="line">前端以三种编码方式传入的数据 都可以取出来(结果可能是QueryDict 或 字典)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">实现：</span></span><br><span class="line"><span class="string">  from/urlencode 直接去取django原生封装的request取</span></span><br><span class="line"><span class="string">  json 去request.boby取出来 然后反序列化返回字典</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  json模块是否支持反序列化bytes格式</span></span><br><span class="line"><span class="string">    3.6以后才支持 否则要decode成字符串在反序列化</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>django原生request(request.POST)</th>
<th>drf封装后的Request对象(request.data)</th>
</tr>
</thead>
<tbody><tr>
<td>form</td>
<td>有数据 QueryDict</td>
<td>有数据 QueryDict</td>
</tr>
<tr>
<td>urlencoded</td>
<td>有数据 QueryDict</td>
<td>有数据 QueryDict</td>
</tr>
<tr>
<td>json</td>
<td>无数据</td>
<td>有数据 普通字典</td>
</tr>
</tbody></table>
<h3 id="requset-query-params"><a href="#requset-query-params" class="headerlink" title="requset.query_params"></a><strong>requset.query_params</strong></h3><p><strong>取GET请求url中的数据</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf Request类方法</span></span><br><span class="line"><span class="comment"># self._request.GET = request.query_params</span></span><br><span class="line"><span class="comment"># django原来取： request.GET</span></span><br><span class="line"><span class="comment"># drf取： request.query_params</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_params</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self._request.GET</span><br></pre></td></tr></table></figure>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Response 是一个类</span><br><span class="line">要使用 就要实例化(需要传参)</span><br><span class="line"></span><br><span class="line">Response(data=<span class="literal">None</span>, status=<span class="literal">None</span>, template_name=<span class="literal">None</span>, </span><br><span class="line">         headers=<span class="literal">None</span>, exception=<span class="literal">False</span>, conetnt_type=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/responses/">drf-response</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 位置：from rest_framework.response import Response</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span>(<span class="params">SimpleTemplateResponse</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    An HttpResponse that allows its data to be rendered into</span></span><br><span class="line"><span class="string">    arbitrary media types.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 实例化参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, data=<span class="literal">None</span>, status=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 template_name=<span class="literal">None</span>, headers=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 exception=<span class="literal">False</span>, content_type=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        data: 响应数据 序列化器.data返回的字典 or 自定义返回字典内容</span></span><br><span class="line"><span class="string">        status: 响应状态码</span></span><br><span class="line"><span class="string">        template_name: drf默认提供的模板 可以修改(自定制)</span></span><br><span class="line"><span class="string">        headers: 响应头</span></span><br><span class="line"><span class="string">        exception: 异常处理</span></span><br><span class="line"><span class="string">        content_type: 响应中 Content-Type标头告诉客户端实际返回的内容的内容类型</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  RESTframework提供了一个响应类Response 使用该类构造响应对象时 响应的具体数据内容会被转换(render渲染)成符合前端需求的类型</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  RESTframework提供了Renderer渲染器 用来根据请求头中的Accept(用户代理期望的MIME类型列表)来自动转换响应数据到对应格式 如果前端请求中未进行Accept声明 则会采用默认方式处理响应数据 我们可以通过配置来修改默认响应格式</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>从修改默认响应渲染类看drf配置解析顺序</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在rest_framework.settings查找所有的drf默认配置项</span></span><br><span class="line">DEFAULTS = &#123;</span><br><span class="line">    <span class="comment"># Base API policies</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: [  <span class="comment"># 默认响应渲染类</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>,  <span class="comment"># json渲染器</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.BrowsableAPIRenderer&#x27;</span>,  <span class="comment"># 浏览API渲染器</span></span><br><span class="line">    ]</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">默认：浏览器响应成浏览器的格式 postman响应成json格式 - 通过配置实现</span></span><br><span class="line"><span class="string">可以修改：</span></span><br><span class="line"><span class="string">  1. 局部使用 - 对某个视图类有效</span></span><br><span class="line"><span class="string">  2. 全局使用 - 对全部视图类有效</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">注意：drf有默认的配置文件 即rest_framework.settings </span><br><span class="line">找的时候 先从项目的settings.py中找 -&gt; 找不到采用自己默认的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局：django项目settings.py配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;  </span><br><span class="line">    <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>, <span class="comment"># 使浏览器访问也返回json数据</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部：视图函数中修改(类属性)</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 局部对视图类做配置(类属性)</span></span><br><span class="line">    renderer_classes = [<span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;ok&#x27;</span>&#125;)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 总结：drf的配置信息查找顺序(源码：面向对象属性解析顺序)</span></span><br><span class="line">先从自己类中找类属性配置 </span><br><span class="line">-&gt; django项目的settings.py中的REST_FRAMEWORK = [] 命名空间配置</span><br><span class="line">-&gt; drf自己的默认配置 rest_framework.settings</span><br><span class="line"></span><br><span class="line"><span class="comment"># django也有两套配置文件</span></span><br><span class="line"><span class="comment"># settings.py | django.conf.global_settings.py</span></span><br><span class="line">思考：两套配置问价 如何 实现顺序的查找</span><br><span class="line">     - 类的继承可以实现 但是django这里不是 它是单个的模块</span><br><span class="line">     - django的实现：一个配置字典 先读取老的&#123;key:value&#125; 再读取新的&#123;key:value&#125;</span><br><span class="line">       字典特性：key不重复 新的key的value会覆盖老的</span><br></pre></td></tr></table></figure>
<h3 id="构造方式"><a href="#构造方式" class="headerlink" title="构造方式"></a>构造方式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        print(request)</span><br><span class="line">        <span class="comment"># 返回用了默认templates渲染 如果使用浏览器访问 需要注册rest_framework</span></span><br><span class="line">        <span class="comment"># 否则浏览器会访问api.html 提示: TemplateDoesNotExist</span></span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;minho&#x27;</span>&#125;,</span><br><span class="line">                        status=<span class="number">201</span>,</span><br><span class="line">                        headers=&#123;<span class="string">&#x27;token&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>响应示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP 201 Created</span><br><span class="line">Allow: GET, HEAD, OPTIONS</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Vary: Accept</span><br><span class="line">token: xxx</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;minho&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>常用属性</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Response().data</span><br><span class="line">传给response对象的序列化后 但尚未render处理的数据</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> Response.status_code</span><br><span class="line">状态码的数字</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> Response.content</span><br><span class="line">经过render处理后的响应数据</span><br></pre></td></tr></table></figure>
<h3 id="响应data"><a href="#响应data" class="headerlink" title="响应data"></a>响应data</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">响应内容：</span></span><br><span class="line"><span class="string">  data就是你要返回的数据 是一个字典</span></span><br><span class="line"><span class="string">  可以是Serializer序列化后的字典 也可以是自定义的字典</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="响应status"><a href="#响应status" class="headerlink" title="响应status"></a>响应status</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">响应状态码： </span></span><br><span class="line"><span class="string">  直接使用status定义的状态码 默认返回 200 OK</span></span><br><span class="line"><span class="string">  它把所有使用到的状态码都定义成了常量 将数字对应了更明确的标识符</span></span><br><span class="line"><span class="string">  return Response(&#123;&#x27;name&#x27;: &#x27;minho&#x27;&#125;,</span></span><br><span class="line"><span class="string">                  status=status.HTTP_200_OK,</span></span><br><span class="line"><span class="string">                  headers=&#123;&#x27;token&#x27;: &#x27;xxx&#x27;&#125;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"><span class="comment"># status模块内容</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_informational</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span> &lt;= code &lt;= <span class="number">199</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_success</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">200</span> &lt;= code &lt;= <span class="number">299</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_redirect</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">300</span> &lt;= code &lt;= <span class="number">399</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_client_error</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">400</span> &lt;= code &lt;= <span class="number">499</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_server_error</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">500</span> &lt;= code &lt;= <span class="number">599</span></span><br><span class="line"></span><br><span class="line">HTTP_100_CONTINUE = <span class="number">100</span></span><br><span class="line">HTTP_101_SWITCHING_PROTOCOLS = <span class="number">101</span></span><br><span class="line">HTTP_200_OK = <span class="number">200</span></span><br><span class="line">HTTP_201_CREATED = <span class="number">201</span></span><br><span class="line">HTTP_202_ACCEPTED = <span class="number">202</span></span><br><span class="line">HTTP_203_NON_AUTHORITATIVE_INFORMATION = <span class="number">203</span></span><br><span class="line">HTTP_204_NO_CONTENT = <span class="number">204</span></span><br><span class="line">HTTP_205_RESET_CONTENT = <span class="number">205</span></span><br><span class="line">HTTP_206_PARTIAL_CONTENT = <span class="number">206</span></span><br><span class="line">HTTP_207_MULTI_STATUS = <span class="number">207</span></span><br><span class="line">HTTP_208_ALREADY_REPORTED = <span class="number">208</span></span><br><span class="line">HTTP_226_IM_USED = <span class="number">226</span></span><br><span class="line">HTTP_300_MULTIPLE_CHOICES = <span class="number">300</span></span><br><span class="line">HTTP_301_MOVED_PERMANENTLY = <span class="number">301</span></span><br><span class="line">HTTP_302_FOUND = <span class="number">302</span></span><br><span class="line">HTTP_303_SEE_OTHER = <span class="number">303</span></span><br><span class="line">HTTP_304_NOT_MODIFIED = <span class="number">304</span></span><br><span class="line">HTTP_305_USE_PROXY = <span class="number">305</span></span><br><span class="line">HTTP_306_RESERVED = <span class="number">306</span></span><br><span class="line">HTTP_307_TEMPORARY_REDIRECT = <span class="number">307</span></span><br><span class="line">HTTP_308_PERMANENT_REDIRECT = <span class="number">308</span></span><br><span class="line">HTTP_400_BAD_REQUEST = <span class="number">400</span></span><br><span class="line">HTTP_401_UNAUTHORIZED = <span class="number">401</span></span><br><span class="line">HTTP_402_PAYMENT_REQUIRED = <span class="number">402</span></span><br><span class="line">HTTP_403_FORBIDDEN = <span class="number">403</span></span><br><span class="line">HTTP_404_NOT_FOUND = <span class="number">404</span></span><br><span class="line">HTTP_405_METHOD_NOT_ALLOWED = <span class="number">405</span></span><br><span class="line">HTTP_406_NOT_ACCEPTABLE = <span class="number">406</span></span><br><span class="line">HTTP_407_PROXY_AUTHENTICATION_REQUIRED = <span class="number">407</span></span><br><span class="line">HTTP_408_REQUEST_TIMEOUT = <span class="number">408</span></span><br><span class="line">HTTP_409_CONFLICT = <span class="number">409</span></span><br><span class="line">HTTP_410_GONE = <span class="number">410</span></span><br><span class="line">HTTP_411_LENGTH_REQUIRED = <span class="number">411</span></span><br><span class="line">HTTP_412_PRECONDITION_FAILED = <span class="number">412</span></span><br><span class="line">HTTP_413_REQUEST_ENTITY_TOO_LARGE = <span class="number">413</span></span><br><span class="line">HTTP_414_REQUEST_URI_TOO_LONG = <span class="number">414</span></span><br><span class="line">HTTP_415_UNSUPPORTED_MEDIA_TYPE = <span class="number">415</span></span><br><span class="line">HTTP_416_REQUESTED_RANGE_NOT_SATISFIABLE = <span class="number">416</span></span><br><span class="line">HTTP_417_EXPECTATION_FAILED = <span class="number">417</span></span><br><span class="line">HTTP_418_IM_A_TEAPOT = <span class="number">418</span></span><br><span class="line">HTTP_422_UNPROCESSABLE_ENTITY = <span class="number">422</span></span><br><span class="line">HTTP_423_LOCKED = <span class="number">423</span></span><br><span class="line">HTTP_424_FAILED_DEPENDENCY = <span class="number">424</span></span><br><span class="line">HTTP_426_UPGRADE_REQUIRED = <span class="number">426</span></span><br><span class="line">HTTP_428_PRECONDITION_REQUIRED = <span class="number">428</span></span><br><span class="line">HTTP_429_TOO_MANY_REQUESTS = <span class="number">429</span></span><br><span class="line">HTTP_431_REQUEST_HEADER_FIELDS_TOO_LARGE = <span class="number">431</span></span><br><span class="line">HTTP_451_UNAVAILABLE_FOR_LEGAL_REASONS = <span class="number">451</span></span><br><span class="line">HTTP_500_INTERNAL_SERVER_ERROR = <span class="number">500</span></span><br><span class="line">HTTP_501_NOT_IMPLEMENTED = <span class="number">501</span></span><br><span class="line">HTTP_502_BAD_GATEWAY = <span class="number">502</span></span><br><span class="line">HTTP_503_SERVICE_UNAVAILABLE = <span class="number">503</span></span><br><span class="line">HTTP_504_GATEWAY_TIMEOUT = <span class="number">504</span></span><br><span class="line">HTTP_505_HTTP_VERSION_NOT_SUPPORTED = <span class="number">505</span></span><br><span class="line">HTTP_506_VARIANT_ALSO_NEGOTIATES = <span class="number">506</span></span><br><span class="line">HTTP_507_INSUFFICIENT_STORAGE = <span class="number">507</span></span><br><span class="line">HTTP_508_LOOP_DETECTED = <span class="number">508</span></span><br><span class="line">HTTP_509_BANDWIDTH_LIMIT_EXCEEDED = <span class="number">509</span></span><br><span class="line">HTTP_510_NOT_EXTENDED = <span class="number">510</span></span><br><span class="line">HTTP_511_NETWORK_AUTHENTICATION_REQUIRED = <span class="number">511</span></span><br></pre></td></tr></table></figure>
<h3 id="响应template-name"><a href="#响应template-name" class="headerlink" title="响应template_name"></a>响应template_name</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">响应模板名：</span></span><br><span class="line"><span class="string">  指定渲染的模板名字 可以自定义模板 基本用不到 了解即可</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="响应headers"><a href="#响应headers" class="headerlink" title="响应headers"></a>响应headers</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers">MDN HTTP消息头详解</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">响应头：</span></span><br><span class="line"><span class="string">  可以往响应头放东西 就是一个字典 具体headers字段及含义 参考上面链接  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django设置头字段</span></span><br><span class="line"><span class="comment"># 要设置或删除响应中的头字段 请像对待字典一样对待它</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = HttpResponse()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;Age&#x27;</span>] = <span class="number">120</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> response[<span class="string">&#x27;Age&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="响应content-type"><a href="#响应content-type" class="headerlink" title="响应content_type"></a>响应content_type</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type">MDN Content-Type </a></p>
<p><a target="_blank" rel="noopener" href="https://www.iana.org/assignments/media-types/media-types.xhtml">Media Types</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">响应编码格式：</span></span><br><span class="line"><span class="string">  请求也有 实体头部用于指示资源的MIME类型 media type</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="封装Response对象"><a href="#封装Response对象" class="headerlink" title="封装Response对象"></a>封装Response对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自己封装Response对象</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIResponse</span>(<span class="params">Response</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            self,</span></span></span><br><span class="line"><span class="function"><span class="params">            code=<span class="number">100</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            msg=<span class="string">&#x27;success&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            result=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            status=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            headers=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            **kwargs</span>):</span></span><br><span class="line">        dic = &#123;<span class="string">&#x27;code&#x27;</span>: code, <span class="string">&#x27;msg&#x27;</span>: msg&#125;</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            dic[<span class="string">&#x27;result&#x27;</span>] = result</span><br><span class="line">        dic.update(kwargs)</span><br><span class="line">        <span class="comment"># super() 对象来调用对应的绑定方法 会自动注入self</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(data=dic, status=status, headers=headers)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 类来调用对象的绑定方法 这个方法就是一个普通函数 有几个参数传几个参数</span></span><br><span class="line">        <span class="comment"># Response.__init__(data=dic, status=status, headers=headers)</span></span><br></pre></td></tr></table></figure>
<h1 id="视图家族"><a href="#视图家族" class="headerlink" title="视图家族"></a>视图家族</h1><h2 id="两个视图基类"><a href="#两个视图基类" class="headerlink" title="两个视图基类"></a>两个视图基类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">APIView         <span class="comment"># 继承django View</span></span><br><span class="line"></span><br><span class="line">GenericAPIView  <span class="comment"># 继承drf APIVIew 做了一些扩展 重要的如下 看源码重点关注</span></span><br><span class="line">  类属性：</span><br><span class="line">    - queryset = <span class="literal">None</span></span><br><span class="line">    - serializer_class = <span class="literal">None</span></span><br><span class="line">  类方法：</span><br><span class="line">    - get_queryset()   常用</span><br><span class="line">    - get_object()     获取一条数据</span><br><span class="line">    - get_serializer() 常用</span><br><span class="line">    - get_setrializer_class() 内部来用 外部会重写(视图类中用到多个序列化器的时候)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_object()源码解析</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span>(<span class="params">views.APIView</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns the object the view is displaying.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        You may want to override this if you need to provide non-standard</span></span><br><span class="line"><span class="string">        queryset lookups.  Eg if objects are referenced using multiple</span></span><br><span class="line"><span class="string">        keyword arguments in the url conf.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 返回所有数据queryset对象 会有过滤</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform the lookup filtering.</span></span><br><span class="line">        <span class="comment"># lookup_field = &#x27;pk&#x27;  </span></span><br><span class="line">        <span class="comment"># lookup_url_kwarg = None</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        url路径 对应有名分组的名字 默认叫 pk 不对应则报错</span></span><br><span class="line"><span class="string">        如果需要修改：在自己的视图类 重写定义上面两个字段的其中一个</span></span><br><span class="line"><span class="string">        这里的lookup_url_kwarg 就是pk(默认) </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        lookup_url_kwarg = self.lookup_url_kwarg <span class="keyword">or</span> self.lookup_field</span><br><span class="line">		</span><br><span class="line">        <span class="comment"># &#123;pk: 4&#125; url有名分组 -&gt; 关键字传参到对应的视图函数</span></span><br><span class="line">        filter_kwargs = &#123;self.lookup_field: self.kwargs[lookup_url_kwarg]&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 根据pk=4 去queryset对象中get单个对象</span></span><br><span class="line">        obj = get_object_or_404(queryset, **filter_kwargs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># May raise a permission denied</span></span><br><span class="line">        self.check_object_permissions(self.request, obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>
<h3 id="APIView-1"><a href="#APIView-1" class="headerlink" title="APIView"></a>APIView</h3><ul>
<li><strong>继承APIView实现5个常用接口</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面视图类继承APIView写CBV 已经能比较快速的写出5个常用接口</span></span><br><span class="line"><span class="comment"># CBV代码如下：</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetail</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取一个数据&quot;&quot;&quot;</span></span><br><span class="line">        book = Book.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        serializer = BookSerializer(instance=book)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;修改一个数据&quot;&quot;&quot;</span></span><br><span class="line">        book = Book.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        serializer = BookSerializer(book, request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;删除一个数据&quot;&quot;&quot;</span></span><br><span class="line">        Book.objects.<span class="built_in">filter</span>(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksList</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取数据列表(所有数据)&quot;&quot;&quot;</span></span><br><span class="line">        books = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = BookSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;新增一个数据&quot;&quot;&quot;</span></span><br><span class="line">        serializer = BookSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br></pre></td></tr></table></figure>
<h3 id="GenericAPIVIew"><a href="#GenericAPIVIew" class="headerlink" title="GenericAPIVIew"></a>GenericAPIVIew</h3><ul>
<li><strong>源码分析</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span>(<span class="params">views.APIView</span>):</span></span><br><span class="line">    queryset = <span class="literal">None</span></span><br><span class="line">    serializer_class = <span class="literal">None</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> self.queryset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, (</span><br><span class="line">            <span class="string">&quot;&#x27;%s&#x27; should either include a `queryset` attribute, &quot;</span></span><br><span class="line">            <span class="string">&quot;or override the `get_queryset()` method.&quot;</span></span><br><span class="line">            % self.__class__.__name__</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(queryset, QuerySet):</span><br><span class="line">            <span class="comment"># Ensure queryset is re-evaluated on each request.</span></span><br><span class="line">            queryset = queryset.<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">return</span> queryset    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">看GenericAPIView源码发现 继承该类 需要覆盖2个类属性：</span></span><br><span class="line"><span class="string">  - queryset -&gt; QuertSet对象 - 指定使用哪个模型</span></span><br><span class="line"><span class="string">  - serializer_class -&gt; 序列化器 - 指定使用哪个序列化器来序列化上面模型类对应的数据</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">看get_queryset(self)方法知道 queryset可以写两种写法</span></span><br><span class="line"><span class="string">  - queryset = Book.object.all()</span></span><br><span class="line"><span class="string">  - queryset = Book.object  # 源码会自己判断</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>继承GenericView实现上面APIView的接口功能</strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">基于GenericAPIView实现上面5个接口 其实非常简单</span></span><br><span class="line"><span class="string">通过源码我们发现下面规律</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>功能描述</th>
<th>APIView</th>
<th>GenericView</th>
</tr>
</thead>
<tbody><tr>
<td>获取所有数据</td>
<td><code>books = Book.objects.all()</code></td>
<td><code>books = self.get_queryset()</code></td>
</tr>
<tr>
<td>获取单个数据</td>
<td><code>book = Book.objects.filter(pk=pk).first()</code></td>
<td><code>book = self.get_object()</code></td>
</tr>
<tr>
<td>序列化所有数据</td>
<td><code>serializer = BookSerializer(instance=books, many=True)</code></td>
<td><code>serializer = self.get_serializer(instance=books, many=True)</code></td>
</tr>
<tr>
<td>序列化单个数据</td>
<td><code>serializer = BookSerializer(instance=book)</code></td>
<td><code>serializer = self.get_serializer(instance=book)</code></td>
</tr>
<tr>
<td>反序列化单个数据</td>
<td><code>serializer = BookSerializer(data=request.data)</code></td>
<td><code>serializer = self.get_serializer(data=request.data)</code></td>
</tr>
<tr>
<td>删除数据</td>
<td><code>Book.objects.filter(pk=pk).delete()</code></td>
<td><code>self.get_object().delete()</code></td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>发现以上规律后 使用GenericView重写上面5个接口则非常简单</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetail</span>(<span class="params">GenericAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        book = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance=book)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        book = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(book, request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        self.get_object().delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksList</span>(<span class="params">GenericAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        books = self.get_queryset()</span><br><span class="line">        serializer = self.get_serializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">  </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">继承GenericView重写这5个接口之后 有什么优势?</span></span><br><span class="line"><span class="string">  我们只要把具体方法里面的之前表达业务字段的变量(book/books) 替换成 通用的没有具体含义的变量(如：obj)</span></span><br><span class="line"><span class="string">  视图函数的代码实现就变得非常通用</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如何通用?</span></span><br><span class="line"><span class="string">  我们需要序列化其他模型类里面的数据的时候 只需要完成下面三步即可完成CBV视图函数的代码编写</span></span><br><span class="line"><span class="string">  1. 赋值粘贴代码</span></span><br><span class="line"><span class="string">  2. 修改CBV类名(如：BookList -&gt; UserList)</span></span><br><span class="line"><span class="string">  3. 重写赋值 queryset 和 serializer_class 两个类属性</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">  这一步写完之后 虽然比较法方便 但是你会发现具体方法的代码既然都一样(冗余度大) </span><br><span class="line">  每次都要拷贝同样的代码 只是替换不同的数据模型以及对应模型的序列化器</span><br><span class="line">  那我们如果把这些方法通用的代码都封装为不同的Mixin类 然后CBV视图直接使用多继承的方式 岂不是更加方便和简介</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">drf提供了5个视图扩展Mixin类 封装了上面的通用功能</span></span><br><span class="line"><span class="string">后面使用 只需要多继承这些Mixin类 即可使用其封装好的方法</span></span><br><span class="line"><span class="string">  - 序列化所有数据 返回Response  self.list</span></span><br><span class="line"><span class="string">  - 序列化单个数据 返回Response  self.retrieve</span></span><br><span class="line"><span class="string">  - 反序列化一个数据(新增) 返回Response  self.create</span></span><br><span class="line"><span class="string">  - 反序列化一个数据(修改) 返回Response  self.update</span></span><br><span class="line"><span class="string">  - 删除一个数据 返回Response  self.destroy</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="五个视图扩展Mixin类"><a href="#五个视图扩展Mixin类" class="headerlink" title="五个视图扩展Mixin类"></a>五个视图扩展Mixin类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h3 id="ListModelMixin"><a href="#ListModelMixin" class="headerlink" title="ListModelMixin"></a>ListModelMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListModelMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List a queryset.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line"></span><br><span class="line">        page = self.paginate_queryset(queryset)</span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = self.get_serializer(page, many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self.get_paginated_response(serializer.data)</span><br><span class="line"></span><br><span class="line">        serializer = self.get_serializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<h3 id="CreateModelMixin"><a href="#CreateModelMixin" class="headerlink" title="CreateModelMixin"></a>CreateModelMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;Location&#x27;</span>: <span class="built_in">str</span>(data[api_settings.URL_FIELD_NAME])&#125;</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RetrieveModelMixin"><a href="#RetrieveModelMixin" class="headerlink" title="RetrieveModelMixin"></a>RetrieveModelMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveModelMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retrieve</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<h3 id="UpdateModelMixin"><a href="#UpdateModelMixin" class="headerlink" title="UpdateModelMixin"></a>UpdateModelMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateModelMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Update a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        partial = kwargs.pop(<span class="string">&#x27;partial&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance, data=request.data, partial=partial)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_update(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(instance, <span class="string">&#x27;_prefetched_objects_cache&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="comment"># If &#x27;prefetch_related&#x27; has been applied to a queryset, we need to</span></span><br><span class="line">            <span class="comment"># forcibly invalidate the prefetch cache on the instance.</span></span><br><span class="line">            instance._prefetched_objects_cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partial_update</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        kwargs[<span class="string">&#x27;partial&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="DestroyModelMixin"><a href="#DestroyModelMixin" class="headerlink" title="DestroyModelMixin"></a>DestroyModelMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DestroyModelMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Destroy a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">destroy</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        self.perform_destroy(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        instance.delete()</span><br></pre></td></tr></table></figure>
<h3 id="Mixin类使用"><a href="#Mixin类使用" class="headerlink" title="Mixin类使用"></a>Mixin类使用</h3><p><strong>基于GenericAPIView和5个Mixin类重写书籍管理接口</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> CreateModelMixin, ListModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> DestroyModelMixin, RetrieveModelMixin, UpdateModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetail</span>(<span class="params">RetrieveModelMixin, UpdateModelMixin, DestroyModelMixin, GenericAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, pk)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksList</span>(<span class="params">ListModelMixin, CreateModelMixin, GenericAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request)</span><br></pre></td></tr></table></figure>
<h2 id="九个通用视图子类"><a href="#九个通用视图子类" class="headerlink" title="九个通用视图子类"></a>九个通用视图子类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">上面使用多继承 继承对应方法的Mixin类和GenericView类重写几个接口 已经非常简介优雅</span></span><br><span class="line"><span class="string">drf还提供了更方便的继承方法(drf自己完成对应的Mixin和GenericView的继承 你只需要按需继承drf提供的新的类即可)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h3 id="CreateAPIView"><a href="#CreateAPIView" class="headerlink" title="CreateAPIView"></a>CreateAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增一个对象 POST</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateAPIView</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for creating a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="ListAPIView"><a href="#ListAPIView" class="headerlink" title="ListAPIView"></a>ListAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回所有对象 GET</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListAPIView</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for listing a queryset.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="RetrieveAPIView"><a href="#RetrieveAPIView" class="headerlink" title="RetrieveAPIView"></a>RetrieveAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回一个对象 GET  retrieve: 取回</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveAPIView</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                      GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for retrieving a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="DestroyAPIView"><a href="#DestroyAPIView" class="headerlink" title="DestroyAPIView"></a>DestroyAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除一个对象 DELETE</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DestroyAPIView</span>(<span class="params">mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                     GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for deleting a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="UpdateAPIView"><a href="#UpdateAPIView" class="headerlink" title="UpdateAPIView"></a>UpdateAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新一个对象 PUT/PATCH</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateAPIView</span>(<span class="params">mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for updating a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.partial_update(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="ListCreateAPIView"><a href="#ListCreateAPIView" class="headerlink" title="ListCreateAPIView"></a>ListCreateAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List 返回所有对象|新增一个对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListCreateAPIView</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                        mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                        GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for listing a queryset or creating a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="RetrieveUpdateAPIView"><a href="#RetrieveUpdateAPIView" class="headerlink" title="RetrieveUpdateAPIView"></a>RetrieveUpdateAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制删除单个对象 返回一个对象|更新一个对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveUpdateAPIView</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                            mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                            GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for retrieving, updating a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.partial_update(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="RetrieveDestroyAPIView"><a href="#RetrieveDestroyAPIView" class="headerlink" title="RetrieveDestroyAPIView"></a>RetrieveDestroyAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制更新单个对象 返回一个对象|删除一个对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveDestroyAPIView</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                             mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                             GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for retrieving or deleting a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="RetrieveUpdateDestroyAPIView"><a href="#RetrieveUpdateDestroyAPIView" class="headerlink" title="RetrieveUpdateDestroyAPIView"></a>RetrieveUpdateDestroyAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Detail 返回一个对象|更新一个对象|删除一个对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveUpdateDestroyAPIView</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                                   GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for retrieving, updating or deleting a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.partial_update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="通用视图子类使用"><a href="#通用视图子类使用" class="headerlink" title="通用视图子类使用"></a>通用视图子类使用</h3><p><strong>根据接口需求继承这9个视图子类重写接口</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">这9个视图子类 都继承于GenericAPIView 然后根据不同的接口需求混入实现不同功能的Mixin类 并且实现对应的 get/post/put/patch/delete 方法 我们只需要根据我们接口需求 继承上面这9个视图子类的其中一个或几个即可 </span></span><br><span class="line"><span class="string">然后仅仅只需提供GenericAPIView视图需要的 queryset 和 serializer_class 两个类属性即可十分简洁的完成接口的书写</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用9个视图子类中的其中2个重写5个书籍管理接口</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> RetrieveUpdateDestroyAPIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksDetail</span>(<span class="params">RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksList</span>(<span class="params">ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">-&gt; 发起请求 </span></span><br><span class="line"><span class="string">-&gt; 路由匹配 </span></span><br><span class="line"><span class="string">-&gt; CBV视图函数 </span></span><br><span class="line"><span class="string">-&gt; as_view()执行返回view函数地址</span></span><br><span class="line"><span class="string">-&gt; view函数执行dispath方法 完成请求分发 </span></span><br><span class="line"><span class="string">-&gt; dispath方法把此次请求的方法名转换为小写(request.method -&gt; GET -&gt; get -&gt; getattr(self, get))</span></span><br><span class="line"><span class="string">-&gt; 通过反射getattr获取CBV视图函数的对应方法名称</span></span><br><span class="line"><span class="string">-&gt; 执行该方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这个时候 我们继承的这9个视图子类 已经封装好了对应请求的方法</span></span><br><span class="line"><span class="string">根据实例属性方法的查找是顺序 比如GET请求过来(request.method = GET)：</span></span><br><span class="line"><span class="string">-&gt; 自己写的CBV视图类找对应的get方法</span></span><br><span class="line"><span class="string">-&gt; 没有找到(这个时候不用再自己提供这些方法) </span></span><br><span class="line"><span class="string">-&gt; 往父类查找</span></span><br><span class="line"><span class="string">-&gt; 最终会在这9个视图子类找到对应封装的get方法执行</span></span><br><span class="line"><span class="string">-&gt; 通用视图子类执行自己的get方法</span></span><br><span class="line"><span class="string">-&gt; 然后调用Mixin类封装的方法序列化/反序列化数据 并返回响应</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="视图集ViewSet"><a href="#视图集ViewSet" class="headerlink" title="视图集ViewSet"></a>视图集ViewSet</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">使用上面通用视图子类 已经非常简洁的实现了5个接口</span></span><br><span class="line"><span class="string">但是我们使用了2个CBV 而且对应的类属性都是一样的(queryset和serializer_calss)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">我们是否可以直接合成一个?</span></span><br><span class="line"><span class="string">问题：合成一个的问题在于 这两个CBV分别都有一个get方法</span></span><br><span class="line"><span class="string">     - 一个get 是获取所有数据</span></span><br><span class="line"><span class="string">     - 另一个get 是获取单个数据</span></span><br><span class="line"><span class="string">如果能解决这个问题 那么就可以合并</span></span><br><span class="line"><span class="string">如何解决?</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="ModelViewSet"><a href="#ModelViewSet" class="headerlink" title="ModelViewSet"></a>ModelViewSet</h3><p><strong>使用ModelViewSet编写5个接口 需要注意路由的变化</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">注意路由变化 使用ViewSet actions参数必须传入</span></span><br><span class="line"><span class="string">简单看下源码发现 此时的as_view方法 已经被ViewSetMixin类重写 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解决同一个get请求需要对应执行不同方法的问题</span></span><br><span class="line"><span class="string">  - 获取所有数据 &#123;&#x27;get&#x27;: &#x27;list&#x27;&#125;</span></span><br><span class="line"><span class="string">  - 获取单个数据 &#123;&#x27;get&#x27;: &#x27;retrieve&#x27;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 使用ViewSet actions参数必须传 是一个字典 &#123;请求小写: 执行的方法名&#125;</span></span><br><span class="line">    <span class="comment"># 当路径匹配上 并且是get请求 会执行BookModelViewSet类的list方法 其余同理</span></span><br><span class="line">    path(<span class="string">&#x27;books/&#x27;</span>, views.BookModelViewSet.as_view(actions=&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span>&#125;)),</span><br><span class="line">    path(<span class="string">&#x27;books/&lt;int:pk&gt;/&#x27;</span>, views.BookModelViewSet.as_view(actions=&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;retrieve&#x27;</span>, <span class="string">&#x27;put&#x27;</span>: <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>: <span class="string">&#x27;destroy&#x27;</span>&#125;)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;合并BookList CBV 和BookDetail CBV&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelViewSet</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br></pre></td></tr></table></figure>
<h3 id="ViewSetMixin源码分析"><a href="#ViewSetMixin源码分析" class="headerlink" title="ViewSetMixin源码分析"></a>ViewSetMixin源码分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ViewSetMixin重写了as_view方法 核心代码</span></span><br><span class="line"><span class="string">只要路由中配置了对应关系 比如 &#123;&#x27;get&#x27;: &#x27;list&#x27;, &#x27;post&#x27;: &#x27;create&#x27;&#125;</span></span><br><span class="line"><span class="string">当get请求过来 就会执行对象的list方法</span></span><br><span class="line"><span class="string">当post请求过来 就会执行对象的create方法</span></span><br><span class="line"><span class="string">  通过反射实现 把扩展Mixin类的 list create方法 拿过来赋值给当前ViewSet对象</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewSetMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the &#x27;GET&#x27; and &#x27;POST&#x27; methods</span></span><br><span class="line"><span class="string">    to the &#x27;list&#x27; and &#x27;create&#x27; actions...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view(&#123;&#x27;get&#x27;: &#x27;list&#x27;, &#x27;post&#x27;: &#x27;create&#x27;&#125;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classonlymethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">cls, actions=<span class="literal">None</span>, **initkwargs</span>):</span></span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">            self = cls(**initkwargs)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;get&#x27;</span> <span class="keyword">in</span> actions <span class="keyword">and</span> <span class="string">&#x27;head&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> actions:</span><br><span class="line">                actions[<span class="string">&#x27;head&#x27;</span>] = actions[<span class="string">&#x27;get&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># &#123;&#x27;get&#x27;: &#x27;list&#x27;, &#x27;post&#x27;: &#x27;create&#x27;&#125;</span></span><br><span class="line">            self.action_map = actions</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Bind methods to actions</span></span><br><span class="line">            <span class="comment"># This is the bit that&#x27;s different to a standard view</span></span><br><span class="line">            <span class="keyword">for</span> method, action <span class="keyword">in</span> actions.items():</span><br><span class="line">                <span class="comment"># method: get | action: list</span></span><br><span class="line">                <span class="comment"># 反射获取属性：执行完handler赋值 handler就变成了list(Mixin类写好的)的内存地址</span></span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, action)</span><br><span class="line">                <span class="comment"># 反射设置属性：当前视图对象.get = list </span></span><br><span class="line">                <span class="comment"># 当get请求过来 CBV经过dispath分发 触发视图函数的.get方法</span></span><br><span class="line">                <span class="built_in">setattr</span>(self, method, handler)</span><br><span class="line">                <span class="comment"># for循环执行完毕 对象.get -&gt; list 对象.post -&gt; create</span></span><br><span class="line"></span><br><span class="line">            self.request = request</span><br><span class="line">            self.args = args</span><br><span class="line">            self.kwargs = kwargs</span><br><span class="line"></span><br><span class="line">            <span class="comment"># And continue as usual</span></span><br><span class="line">            <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line">		...</span><br><span class="line">        <span class="keyword">return</span> csrf_exempt(view)</span><br></pre></td></tr></table></figure>
<h3 id="继承ViewSetMixin的视图类"><a href="#继承ViewSetMixin的视图类" class="headerlink" title="继承ViewSetMixin的视图类"></a>继承ViewSetMixin的视图类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">通过上面源码的分析 我们知道使用ViewSet的时候 as_view需要一个actions参数</span></span><br><span class="line"><span class="string">它会将请求方法(key)与你指定的执行函数(value)绑定</span></span><br><span class="line"><span class="string">那么 继承ViewSetMixin的视图类 我们就可以改写路由 以及改写CBV提供的get/post等的方法名称</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">总结：继承ViewSetMixin视图类 配置好actions参数的映射关系 CBV方法名称可以任意</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;books/&#x27;</span>, views.BookModelViewSet.as_view(actions=&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;get_all_book&#x27;</span>&#125;))</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ViewSetMixin一定要放在APIView前面 </span></span><br><span class="line"><span class="comment"># 多继承属性查找顺序 让as_view方法先找ViewSetMixin的</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelViewSet</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all_book</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        books = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = BookSerializer(books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># drf内置提供了这些继承ViewSetMixin视图类的子类</span></span><br></pre></td></tr></table></figure>
<h4 id="ViewSet"><a href="#ViewSet" class="headerlink" title="ViewSet"></a>ViewSet</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承APIview 就是上一步我们实现的</span></span><br><span class="line"><span class="comment"># 没有提供任何actions方法 需要我们写的代码是最多的</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewSet</span>(<span class="params">ViewSetMixin, views.APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The base ViewSet class does not provide any actions by default.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="GenericViewSet"><a href="#GenericViewSet" class="headerlink" title="GenericViewSet"></a>GenericViewSet</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承GenericView 可以使用GenericView的各种方法</span></span><br><span class="line"><span class="comment"># 涉及到序列化/数据库操作 尽量使用GenericView 方便</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericViewSet</span>(<span class="params">ViewSetMixin, generics.GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The GenericViewSet class does not provide any actions by default,</span></span><br><span class="line"><span class="string">    but does include the base set of generic view behavior, such as</span></span><br><span class="line"><span class="string">    the `get_object` and `get_queryset` methods.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="ReadOnlyModelViewSet"><a href="#ReadOnlyModelViewSet" class="headerlink" title="ReadOnlyModelViewSet"></a>ReadOnlyModelViewSet</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只读视图集 只提供获取所有数据 和获取单个数据的方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadOnlyModelViewSet</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                           GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A viewset that provides default `list()` and `retrieve()` actions.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="ModelViewSet-1"><a href="#ModelViewSet-1" class="headerlink" title="ModelViewSet"></a>ModelViewSet</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面使用的ModelViewSet 提供了5个接口的实现方法</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">get    -  list/retrieve</span></span><br><span class="line"><span class="string">post   -  create</span></span><br><span class="line"><span class="string">put    -  update</span></span><br><span class="line"><span class="string">patch  -  partial_update</span></span><br><span class="line"><span class="string">delete -  destroy</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h1 id="路由Routers"><a href="#路由Routers" class="headerlink" title="路由Routers"></a>路由Routers</h1><h2 id="简单写法"><a href="#简单写法" class="headerlink" title="简单写法"></a>简单写法</h2><p><strong>在urls.py中配置</strong></p>
<h3 id="FBV"><a href="#FBV" class="headerlink" title="FBV"></a><strong>FBV</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;publishs/&lt;int:pk&gt;/&#x27;</span>, views.detail)</span><br></pre></td></tr></table></figure>
<h3 id="CBV"><a href="#CBV" class="headerlink" title="CBV"></a><strong>CBV</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;publishs/&lt;int:pk&gt;/&#x27;</span>, views.PublishDetail.as_view())</span><br></pre></td></tr></table></figure>
<h3 id="ViewSetMixin"><a href="#ViewSetMixin" class="headerlink" title="ViewSetMixin"></a>ViewSetMixin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一旦视图类继承ViewSetMixin之后 写法稍有不同</span></span><br><span class="line"><span class="comment"># as_view() 必须传入actions参数(位置或关键字传参)</span></span><br><span class="line"><span class="comment"># ViewSetMixin重写as_view 比如get：通过反射取&#x27;list&#x27;函数 赋值给&#x27;get&#x27;</span></span><br><span class="line">path(<span class="string">&#x27;books/&#x27;</span>, views.BookViewSet.as_view(actions=&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure>
<h2 id="Routers"><a href="#Routers" class="headerlink" title="Routers"></a>Routers</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对于视图集ViewSet 我们除了可以手动指明请求的方式与动作action之间的对应关系以外</span><br><span class="line">还可以使用Routers来帮助我们快速实现路由信息</span><br></pre></td></tr></table></figure>
<p><strong>routers写法</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承自ModelViewSet的路由Routers写法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 导入routers模块</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 该模块有两个类 实例化得到对象</span></span><br><span class="line"><span class="comment"># routers.DefaultRouter() -&gt; 生成的路由更多</span></span><br><span class="line"><span class="comment"># routers.SimpleRouter() -&gt; 生成两条路由</span></span><br><span class="line"><span class="comment"># router = routers.SimpleRouter()</span></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 注册</span></span><br><span class="line"><span class="comment"># prefix: 路由前缀 不要加斜杠</span></span><br><span class="line"><span class="comment"># viewset: 继承自ModelViewSet的视图类</span></span><br><span class="line"><span class="comment"># basename: 别名 reverse反向解析使用</span></span><br><span class="line"><span class="comment"># router.register(prefix, viewset, basename=None)</span></span><br><span class="line">router.register(<span class="string">&#x27;books&#x27;</span>, views.BookViewSet)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 将router.urls自动生成的路由加到原路由中</span></span><br><span class="line">     <span class="number">4.1</span> urlpatterns += router.urls</span><br><span class="line">     <span class="number">4.2</span> urlpatterns = [path(<span class="string">&#x27;&#x27;</span>, include(router.urls))]</span><br></pre></td></tr></table></figure>
<h3 id="SimpleRouter和DefaultRouter"><a href="#SimpleRouter和DefaultRouter" class="headerlink" title="SimpleRouter和DefaultRouter"></a>SimpleRouter和DefaultRouter</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;SimpleRouter 自动生成2条路由&quot;&quot;&quot;</span></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books/$&#x27;</span> [name=<span class="string">&#x27;book-list&#x27;</span>]&gt;,</span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books/(?P&lt;pk&gt;[^/.]+)/$&#x27;</span> [name=<span class="string">&#x27;book-detail&#x27;</span>]&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;DefaultRouter 自动生成6条路由&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 这两条跟SimpleRouter一样</span></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books/$&#x27;</span> [name=<span class="string">&#x27;book-list&#x27;</span>]&gt;, </span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books/(?P&lt;pk&gt;[^/.]+)/$&#x27;</span> [name=<span class="string">&#x27;book-detail&#x27;</span>]&gt;, </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面两条有名分组：format关键字传参</span></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books\.(?P&lt;format&gt;[a-z0-9]+)/?$&#x27;</span> [name=<span class="string">&#x27;book-list&#x27;</span>]&gt;,  <span class="comment"># http://127.0.0.1:8000/books.json</span></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^books/(?P&lt;pk&gt;[^/.]+)\.(?P&lt;format&gt;[a-z0-9]+)/?$&#x27;</span> [name=<span class="string">&#x27;book-detail&#x27;</span>]&gt;,  <span class="comment"># http://127.0.0.1:8000/books/5.json</span></span><br><span class="line"></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^$&#x27;</span> [name=<span class="string">&#x27;api-root&#x27;</span>]&gt;,   <span class="comment"># 根路径会显示出所有可以访问的地址</span></span><br><span class="line">&lt;URLPattern <span class="string">&#x27;^\.(?P&lt;format&gt;[a-z0-9]+)/?$&#x27;</span> [name=<span class="string">&#x27;api-root&#x27;</span>]&gt;  <span class="comment"># http://127.0.0.1:8000/books/books.api|.json</span></span><br></pre></td></tr></table></figure>
<h2 id="action使用"><a href="#action使用" class="headerlink" title="action使用"></a>action使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 作用：为了给继承自ModelViewSet的视图类中自定义的方法自动生成路由</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如何使用?</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewSet</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    action是一个带参装饰器</span></span><br><span class="line"><span class="string">    参数：methods -&gt; 是一个列表 列表中放请求方式 methods=[&#x27;GET&#x27;, &#x27;POST&#x27;]</span></span><br><span class="line"><span class="string">    参数：detail -&gt; 布尔类型 True/False 是否带pk</span></span><br><span class="line"><span class="string">      - True: ^books/(?P&lt;pk&gt;[^/.]+)/get_one/$ 生成带pk的地址</span></span><br><span class="line"><span class="string">      - False: ^books/get_one/ 生成不带pk的地址</span></span><br><span class="line"><span class="string">    当朝生成的地址发送methods里面支持的请求 会执行下面的函数</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_one</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        print(pk)</span><br><span class="line">        <span class="comment"># 截取1条</span></span><br><span class="line">        book = self.get_queryset()[:<span class="number">2</span>]</span><br><span class="line">        <span class="comment"># 虽然只取1条 但是结果仍然是可迭代对象 不是单个对象 仍需设置many=True</span></span><br><span class="line">        serializer = self.get_serializer(book, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<h1 id="认证组件"><a href="#认证组件" class="headerlink" title="认证组件"></a>认证组件</h1><p><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/authentication/">Authentication</a></p>
<h2 id="认证类的写法"><a href="#认证类的写法" class="headerlink" title="认证类的写法"></a>认证类的写法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">drf认证得实现：</span></span><br><span class="line"><span class="string">  1. 写一个类 继承BaseAuthentication</span></span><br><span class="line"><span class="string">     注：不继承也可以 只要实现authenticate方法即可 它只是规定了子类的行为 不用一定继承它</span></span><br><span class="line"><span class="string">  2. 重写authenticate方法(实现认证得逻辑) 因为源码中 调用的时候 需要执行认证类的该方法</span></span><br><span class="line"><span class="string">     2.1 认证通过 返回两个值(self.user self.auth) </span></span><br><span class="line"><span class="string">         - self.user最终给request.user 当前登录用户</span></span><br><span class="line"><span class="string">         - self.auth</span></span><br><span class="line"><span class="string">     2.2 认证失败 抛异常：AuthenticationFailed(推荐这个) or APIException</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string">  3. 使用</span></span><br><span class="line"><span class="string">     3.1 全局使用 settings.py配置</span></span><br><span class="line"><span class="string">     3.2 局部使用 视图类写类属性</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string">     看源码知道 全局或者局部配置的属性名字为 如：authentication_classes = [SessionAuthentication, BasicAuthentication]</span></span><br><span class="line"><span class="string">     需要是一个可迭代对象 可以配置多个 按顺序执行 类似配置认证装饰器</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="认证源码分析"><a href="#认证源码分析" class="headerlink" title="认证源码分析"></a>认证源码分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">-&gt; APIView </span></span><br><span class="line"><span class="string">-&gt; dispath方法 </span></span><br><span class="line"><span class="string">-&gt; self.initial(request, *args, **kwargs)</span></span><br><span class="line"><span class="string">-&gt; self.initial里面包含：</span></span><br><span class="line"><span class="string">   - 认证 self.perform_authentication(request)  # 认证组件</span></span><br><span class="line"><span class="string">   - 权限 self.check_permissions(request)</span></span><br><span class="line"><span class="string">   - 频率 self.check_throttles(request)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># 读：self.perform_authentication(request)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">     authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 实例化Request类 传入authenticators认证器  </span></span><br><span class="line">        <span class="keyword">return</span> Request(</span><br><span class="line">            request,</span><br><span class="line">            parsers=self.get_parsers(),</span><br><span class="line">            <span class="comment"># 是一个列表 [认证类的对象, 认证类的对象, ...]</span></span><br><span class="line">            authenticators=self.get_authenticators(),</span><br><span class="line">            negotiator=self.get_content_negotiator(),</span><br><span class="line">            parser_context=parser_context</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 列表解析式 去自己的authentication_classes(可迭代对象)取auth 然后直接auth() 执行</span></span><br><span class="line">        <span class="comment"># 这里authentication_classes是一个APIView的类属性 取的默认配置</span></span><br><span class="line">        <span class="comment"># 列表中是一堆对象(认证类实例) 视图类中配置的authentication_classes = [类名]</span></span><br><span class="line">        <span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_classes]   </span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        self.perform_authentication(request)</span><br><span class="line">        self.check_permissions(request)</span><br><span class="line">        self.check_throttles(request)</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_authentication</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 就一句话 需要去drf的Request类中查找user属性(方法)</span></span><br><span class="line">        <span class="comment"># 进源码看 实际是一个方法 用@property包装成了一个属性</span></span><br><span class="line">        request.user</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;_user&#x27;</span>):</span><br><span class="line">            <span class="keyword">with</span> wrap_attributeerrors():  <span class="comment"># 上下文管理</span></span><br><span class="line">                <span class="comment"># 刚开始来 没有_user 走self._authenticate</span></span><br><span class="line">                self._authenticate()  <span class="comment"># 核心</span></span><br><span class="line">        <span class="comment"># 有用户 直接返回用户</span></span><br><span class="line">        <span class="keyword">return</span> self._user</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 做认证 核心</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># self.authenticators Request类实例化(APIView的dispath的时候实例化的)的时候传入的参数</span></span><br><span class="line">        <span class="comment"># 这个参数的类型：是配置的一堆认证类产生的认证类对象组成的list</span></span><br><span class="line">        <span class="comment"># 遍历拿到一个个认证器(认证类的实例化后得到的对象) 进行认证</span></span><br><span class="line">        <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 认证器(对象)调用authenticate(认证类对象(认证类自动注入的self), request请求对象) 所以自定义类实现该方法的时候 需要一个形参接收该self(request请求对象)</span></span><br><span class="line">                <span class="comment"># 返回值：登录用户与认证的信息组成的tuple</span></span><br><span class="line">                <span class="comment"># try语句 认证失败抛出异常</span></span><br><span class="line">                user_auth_tuple = authenticator.authenticate(self)  <span class="comment"># 这里的self是request请求对象</span></span><br><span class="line">            <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">                self._not_authenticated()</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">			</span><br><span class="line">            <span class="comment"># 返回值的处理</span></span><br><span class="line">            <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self._authenticator = authenticator</span><br><span class="line">                <span class="comment"># 如果有返回值 将 登录用户 与 登录认证 分别保存到 request.user request.auth</span></span><br><span class="line">                self.user, self.auth = user_auth_tuple</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">		<span class="comment"># 如果返回值user_auth_tuple为空 代表认证通过</span></span><br><span class="line">        <span class="comment"># 但是没有登录用户与登录信息 代表匿名用户(游客)</span></span><br><span class="line">        self._not_authenticated()</span><br></pre></td></tr></table></figure>
<h2 id="自定义认证类"><a href="#自定义认证类" class="headerlink" title="自定义认证类"></a>自定义认证类</h2><h3 id="简单登录实现"><a href="#简单登录实现" class="headerlink" title="简单登录实现"></a>简单登录实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">测试简单存了一个token值到服务端数据库 仅为测试方便类似session</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>认证测试模型</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">256</span>)</span><br><span class="line">    user_type = models.IntegerField(choices=((<span class="number">1</span>, <span class="string">&#x27;超级用户&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;普通用户&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;二笔用户&#x27;</span>)))</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line">    register_time = models.DateField()</span><br><span class="line">    gender_choices = [(<span class="number">1</span>, <span class="string">&#x27;男&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;女&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;其他&#x27;</span>)]</span><br><span class="line">    gender = models.IntegerField(choices=gender_choices)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserToken</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;垂直分表(库)|水平分表(库)&quot;&quot;&quot;</span></span><br><span class="line">    token = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 一对一关联到User表 一对一：就是垂直分表</span></span><br><span class="line">    user = models.OneToOneField(to=<span class="string">&#x27;User&#x27;</span>, on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>认证视图函数</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="comment"># 登录成功 生成一个随机字符串</span></span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            <span class="comment"># 存到UserToken表中</span></span><br><span class="line">            <span class="comment"># models.UserToken.objects.create(token=token, user=user)  # 这种方式每次登录都会记录一条 不好 有记录 更新即可</span></span><br><span class="line">            <span class="comment"># update_or_create 没有就新增 有就更新</span></span><br><span class="line">            models.UserToken.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>: token&#125;, user=user)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;status&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>: token&#125;)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;status&#x27;</span>: <span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;用户名或密码错误&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="实现自定义认证类"><a href="#实现自定义认证类" class="headerlink" title="实现自定义认证类"></a>实现自定义认证类</h3><ul>
<li><strong>编写自定义认证类</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserToken</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">访问URL 需要写法token参数：</span></span><br><span class="line"><span class="string">127.0.0.1:8000/books/?token=147f71b0-7665-4a06-a178-24fbe98c9332</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 认证逻辑</span></span><br><span class="line">        <span class="comment"># 如果认证通过 返回元组(user, auth)</span></span><br><span class="line">        token = request.query_params.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_token = UserToken.objects.get(token=token)</span><br><span class="line">                <span class="comment"># 这里返回(user对象, token) 不一定返回user对象</span></span><br><span class="line">                <span class="comment"># 可以返回字符串(user_token.user.username)或其他 返回对象 后面方便request.user使用</span></span><br><span class="line">                <span class="keyword">return</span> user_token.user, token</span><br><span class="line">            <span class="keyword">except</span> models.ObjectDoesNotExist:</span><br><span class="line">                <span class="comment"># 如果认证失败 抛出AuthenticationFailed异常</span></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;认证失败&#x27;</span>)</span><br><span class="line">        <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;请求地址中需要携带token&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>使用自定义认证类</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewSet</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    authentication_classes = [MyAuthentication]  <span class="comment"># 局部配置</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line"></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;get&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_one</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        print(request.user)  <span class="comment"># user - minho</span></span><br><span class="line">        print(request.auth)  <span class="comment"># token - 147f71b0-7665-4a06-a178-24fbe98c9332 </span></span><br><span class="line">        book = self.get_queryset()[:<span class="number">1</span>]</span><br><span class="line">        serializer = BookSerializer(book, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 全局配置 settings.py</span></span><br><span class="line"><span class="comment"># 可以有多个 顺序执行配置的认证类</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">需要注意：如果配置多个认证类 要把返回两个值的放到最后</span></span><br><span class="line"><span class="string">        因为request.user request.auth会一直重复覆盖</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&quot;DEFAULT_AUTHENTICATION_CLASSES&quot;</span>: [<span class="string">&#x27;app01.authentication.MyAuthentication&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">全局配置这里有一个问题：</span></span><br><span class="line"><span class="string">  全局配置后 所有视图都会进行认证 包括登录视图</span></span><br><span class="line"><span class="string">  还没登录就进行认证... </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  这里需要对登录视图做局部配置 登录视图不需要任何认证</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = []  <span class="comment"># 局部禁用认证 置为空列表实现</span></span><br></pre></td></tr></table></figure>
<h2 id="内置认证类"><a href="#内置认证类" class="headerlink" title="内置认证类"></a>内置认证类</h2><h3 id="BasicAuthentication"><a href="#BasicAuthentication" class="headerlink" title="BasicAuthentication"></a>BasicAuthentication</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 针对用户名/密码的HTTP基本身份验证</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicAuthentication</span>(<span class="params">BaseAuthentication</span>):</span> <span class="keyword">pass</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    HTTP Basic authentication against username/password.</span></span><br><span class="line"><span class="string">    &quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="RemoteUserAuthentication"><a href="#RemoteUserAuthentication" class="headerlink" title="RemoteUserAuthentication"></a>RemoteUserAuthentication</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteUserAuthentication</span>(<span class="params">BaseAuthentication</span>):</span> <span class="keyword">pass</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    REMOTE_USER authentication.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    To use this, set up your web server to perform authentication, which will</span></span><br><span class="line"><span class="string">    set the REMOTE_USER environment variable. You will need to have</span></span><br><span class="line"><span class="string">    &#x27;django.contrib.auth.backends.RemoteUserBackend in your</span></span><br><span class="line"><span class="string">    AUTHENTICATION_BACKENDS setting</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="SessionAuthentication"><a href="#SessionAuthentication" class="headerlink" title="SessionAuthentication"></a>SessionAuthentication</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionAuthentication</span>(<span class="params">BaseAuthentication</span>):</span> <span class="keyword">pass</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	Use Django&#x27;s session framework for authentication.	</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="TokenAuthentication"><a href="#TokenAuthentication" class="headerlink" title="TokenAuthentication"></a>TokenAuthentication</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenAuthentication</span>(<span class="params">BaseAuthentication</span>):</span> <span class="keyword">pass</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	Simple token based authentication.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	Clients should authenticate by passing the token key in the &quot;Authorization&quot;</span></span><br><span class="line"><span class="string">	HTTP header, prepended with the string &quot;Token &quot;.  For example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	Authorization: Token 401f7ac837da42b97f613d789819ff93537bee6a</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>


<h1 id="权限组件"><a href="#权限组件" class="headerlink" title="权限组件"></a>权限组件</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">-&gt; APIView </span></span><br><span class="line"><span class="string">-&gt; dispath方法 </span></span><br><span class="line"><span class="string">-&gt; self.initial(request, *args, **kwargs)</span></span><br><span class="line"><span class="string">-&gt; self.initial里面包含：</span></span><br><span class="line"><span class="string">   - 认证 self.perform_authentication(request)</span></span><br><span class="line"><span class="string">   - 权限 self.check_permissions(request)   # 权限组件 在APIView里面 比认证简单一些 而且在认证之后执行 可以拿到request.user</span></span><br><span class="line"><span class="string">   - 频率 self.check_throttles(request)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">权限需要和认证配合使用 给认证的用户 分配不同的权限</span><br></pre></td></tr></table></figure>
<h2 id="权限源码分析"><a href="#权限源码分析" class="headerlink" title="权限源码分析"></a>权限源码分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_permissions</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check if the request should be permitted.</span></span><br><span class="line"><span class="string">        Raises an appropriate exception if the request is not permitted.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> permission <span class="keyword">in</span> self.get_permissions():  <span class="comment"># 权限类的对象 放到列表中</span></span><br><span class="line">            <span class="comment"># 执行权限类的has_permission方法</span></span><br><span class="line">            <span class="comment"># 从原理这里的判断可以看出 返回值应该是 True/False</span></span><br><span class="line">            <span class="comment"># 权限通过：True  不通过：False</span></span><br><span class="line">            <span class="comment"># 在认证之后执行 可以拿到request.user</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> permission.has_permission(request, self):</span><br><span class="line">                self.permission_denied(</span><br><span class="line">                    request,</span><br><span class="line">                    message=<span class="built_in">getattr</span>(permission, <span class="string">&#x27;message&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                    code=<span class="built_in">getattr</span>(permission, <span class="string">&#x27;code&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">                )    </span><br></pre></td></tr></table></figure>
<h2 id="自定义权限类"><a href="#自定义权限类" class="headerlink" title="自定义权限类"></a>自定义权限类</h2><ul>
<li><strong>编写</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. 继承BasePermission</span></span><br><span class="line"><span class="string">2. 重写has_permission</span></span><br><span class="line"><span class="string">   2.1 返回True: 有权限</span></span><br><span class="line"><span class="string">   2.2 返回Flase: 无权限</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserPermission</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="comment"># request drf的request对象</span></span><br><span class="line">    <span class="comment"># view 自己写的视图类对象 也有view.request 可以操作更多属性</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">		<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		实现：不是超级用户 不能访问</span></span><br><span class="line"><span class="string">        由于已经认证过 request.user可以直接取到当前登录用户</span></span><br><span class="line"><span class="string">        if request.user.user_type == 1:</span></span><br><span class="line"><span class="string">            return True</span></span><br><span class="line"><span class="string">        return False</span></span><br><span class="line"><span class="string">        如果该字段使用了choice 通过get_字段名_display()就能取出后面的备注信息</span></span><br><span class="line"><span class="string">        print(request.user.get_user_type_display())</span></span><br><span class="line"><span class="string">		&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> request.user.user_type == <span class="number">1</span> <span class="keyword">else</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>使用</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> BookSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Book</span><br><span class="line"><span class="keyword">from</span> .authentication <span class="keyword">import</span> MyAuthentication</span><br><span class="line"><span class="keyword">from</span> .authentication <span class="keyword">import</span> UserPermission</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewSet</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    authentication_classes = [MyAuthentication]</span><br><span class="line">    permission_classes = [UserPermission]  <span class="comment"># 视图类里面局部使用</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 全局使用 settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">        <span class="string">&quot;DEFAULT_AUTHENTICATION_CLASSES&quot;</span>: [<span class="string">&#x27;app01.authentication.MyAuthentication&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [<span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局使用之后 部分视图需要局部禁用</span></span><br><span class="line">permission_classes = []</span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;detail&quot;</span>: <span class="string">&quot;You do not have permission to perform this action.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内置权限类"><a href="#内置权限类" class="headerlink" title="内置权限类"></a>内置权限类</h2><h3 id="IsAdminUser"><a href="#IsAdminUser" class="headerlink" title="IsAdminUser"></a>IsAdminUser</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用django的Auth模块</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsAdminUser</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Allows access only to admin users.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(request.user <span class="keyword">and</span> request.user.is_staff)</span><br></pre></td></tr></table></figure>
<h3 id="IsAuthenticated"><a href="#IsAuthenticated" class="headerlink" title="IsAuthenticated"></a>IsAuthenticated</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsAuthenticated</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Allows access only to authenticated users.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(request.user <span class="keyword">and</span> request.user.is_authenticated)</span><br></pre></td></tr></table></figure>
<h3 id="IsAuthenticatedOrReadOnly"><a href="#IsAuthenticatedOrReadOnly" class="headerlink" title="IsAuthenticatedOrReadOnly"></a>IsAuthenticatedOrReadOnly</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsAuthenticatedOrReadOnly</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The request is authenticated as a user, or is a read-only request.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(</span><br><span class="line">            request.method <span class="keyword">in</span> SAFE_METHODS <span class="keyword">or</span></span><br><span class="line">            request.user <span class="keyword">and</span></span><br><span class="line">            request.user.is_authenticated</span><br><span class="line">        )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>其余自带权限类参考drf.permissions模块</strong></p>
<h1 id="频率组件"><a href="#频率组件" class="headerlink" title="频率组件"></a>频率组件</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以对接口访问的频次进行限制 以减轻服务器压力</span><br></pre></td></tr></table></figure>
<h2 id="自定义IP频率限制类"><a href="#自定义IP频率限制类" class="headerlink" title="自定义IP频率限制类"></a>自定义IP频率限制类</h2><h3 id="继承BaseThrottle"><a href="#继承BaseThrottle" class="headerlink" title="继承BaseThrottle"></a>继承BaseThrottle</h3><ul>
<li><strong>BaseThrottle源码分析</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseThrottle</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Rate throttling of requests.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Return `True` if the request should be allowed, `False` otherwise.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 该方法判断是否限次 没有限次可以请求返回True 限次了不可以请求返回False</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;.allow_request() must be overridden&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_ident</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Identify the machine making the request by parsing HTTP_X_FORWARDED_FOR</span></span><br><span class="line"><span class="string">        if present and number of proxies is &gt; 0. If not use all of</span></span><br><span class="line"><span class="string">        HTTP_X_FORWARDED_FOR if it is available, if not use REMOTE_ADDR.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        xff = request.META.get(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>)</span><br><span class="line">        remote_addr = request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        num_proxies = api_settings.NUM_PROXIES</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_proxies <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> num_proxies == <span class="number">0</span> <span class="keyword">or</span> xff <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> remote_addr</span><br><span class="line">            addrs = xff.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">            client_addr = addrs[-<span class="built_in">min</span>(num_proxies, <span class="built_in">len</span>(addrs))]</span><br><span class="line">            <span class="keyword">return</span> client_addr.strip()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(xff.split()) <span class="keyword">if</span> xff <span class="keyword">else</span> remote_addr</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Optionally, return a recommended number of seconds to wait before</span></span><br><span class="line"><span class="string">        the next request.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 限次后调用 限制还需要等多久才能再次访问 返回等待时间的seconds</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>自定制频率限制类</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">自定义的逻辑</span></span><br><span class="line"><span class="string">  1. 取出访问者IP</span></span><br><span class="line"><span class="string">  2. 判断当前IP在不在访问字典里</span></span><br><span class="line"><span class="string">     2.1 不在 添加进去 并且直接返回True 表示第一次访问</span></span><br><span class="line"><span class="string">     2.2 在字典里 继续往下走</span></span><br><span class="line"><span class="string">  3. 循环判断当前IP的列表 有值 并且当前时间减去列表的最后一个时间大于60s 把这种数据pop掉 这样列表中只有60s以内的访问记录</span></span><br><span class="line"><span class="string">  4. 判断 </span></span><br><span class="line"><span class="string">     4.1 当列表小于3 说明一分钟以内访问不足三次 把当前时间插入列表第一个位置 返回True 顺序通过</span></span><br><span class="line"><span class="string">     4.2 当大于等于3 说明一分钟内访问超过三次 返回False验证失败</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 频率限制 自定制</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IPThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="comment"># 这里我们的访问字典放在了内存里 重启就会被清空</span></span><br><span class="line">    <span class="comment"># 源码提供的放在了django缓存</span></span><br><span class="line">    VISIT_DIC = &#123;&#125;  <span class="comment"># 定义成类属性 所有对象都用这一个</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 不能设置为类属性 每个IP的列表不一样</span></span><br><span class="line">        self.hisroty_list = []  <span class="comment"># type: list</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        ip = request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.VISIT_DIC:</span><br><span class="line">            self.VISIT_DIC[ip] = [ctime]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 当前访问者的时间列表拿出来</span></span><br><span class="line">        self.history_list = self.VISIT_DIC[ip]</span><br><span class="line">        <span class="comment"># while ctime - history_list[-1] &gt; 60:</span></span><br><span class="line">        <span class="comment">#     history_list.pop()</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> ctime - self.history_list[-<span class="number">1</span>] &gt; <span class="number">60</span>:</span><br><span class="line">                <span class="comment"># 循环把时间列表最后一个与当前时间差大于60s的移除</span></span><br><span class="line">                self.history_list.pop()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># 把全部大于60s的时间移除之后break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history_list) &lt; <span class="number">3</span>:  <span class="comment"># 3 就是配置文件里面配置一分钟可以访问多少次</span></span><br><span class="line">            self.history_list.insert(<span class="number">0</span>, ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># history_list = [第三次 第二次 第一次访问时间戳]</span></span><br><span class="line">        <span class="comment"># 返回该IP还需要等待多少秒可以访问</span></span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>-(ctime - self.history_list[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="number">1.</span> 局部使用 在视图类里使用</span><br><span class="line">   throttle_classes = [MyThrottles,]</span><br><span class="line"><span class="number">2.</span> 全局使用 settings.py</span><br><span class="line">   REST_FRAMEWORK = &#123;</span><br><span class="line">       <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>:[<span class="string">&#x27;app01.utils.MyThrottles&#x27;</span>,]</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="继承SimpleRateThrottle"><a href="#继承SimpleRateThrottle" class="headerlink" title="继承SimpleRateThrottle"></a>继承SimpleRateThrottle</h3><ul>
<li><strong>SimpleRateThrottle源码分析</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleRateThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A simple cache implementation, that only requires `.get_cache_key()`</span></span><br><span class="line"><span class="string">    to be overridden.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The rate (requests / seconds) is set by a `rate` attribute on the View</span></span><br><span class="line"><span class="string">    class.  The attribute is a string of the form &#x27;number_of_requests/period&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Period should be one of: (&#x27;s&#x27;, &#x27;sec&#x27;, &#x27;m&#x27;, &#x27;min&#x27;, &#x27;h&#x27;, &#x27;hour&#x27;, &#x27;d&#x27;, &#x27;day&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Previous request information used for throttling is stored in the cache.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cache = default_cache</span><br><span class="line">    timer = time.time</span><br><span class="line">    cache_format = <span class="string">&#x27;throttle_%(scope)s_%(ident)s&#x27;</span></span><br><span class="line">    scope = <span class="literal">None</span></span><br><span class="line">    THROTTLE_RATES = api_settings.DEFAULT_THROTTLE_RATES</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 通过反射找rate</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(self, <span class="string">&#x27;rate&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            self.rate = self.get_rate()  <span class="comment"># self.rate = &#x27;3/m&#x27;</span></span><br><span class="line">        <span class="comment"># self.num_requests = 3</span></span><br><span class="line">        <span class="comment"># self.duration = 60</span></span><br><span class="line">        self.num_requests, self.duration = self.parse_rate(self.rate)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Should return a unique cache-key which can be used for throttling.</span></span><br><span class="line"><span class="string">        Must be overridden.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        May return `None` if the request should not be throttled.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 必须重写 返回谁 用什么做key</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;.get_cache_key() must be overridden&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_rate</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Determine the string representation of the allowed request rate.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(self, <span class="string">&#x27;scope&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            msg = (<span class="string">&quot;You must set either `.scope` or `.rate` for &#x27;%s&#x27; throttle&quot;</span> %</span><br><span class="line">                   self.__class__.__name__)</span><br><span class="line">            <span class="keyword">raise</span> ImproperlyConfigured(msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 去配置文件取配置的scope值 &#x27;3/m&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> self.THROTTLE_RATES[self.scope]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            msg = <span class="string">&quot;No default throttle rate set for &#x27;%s&#x27; scope&quot;</span> % self.scope</span><br><span class="line">            <span class="keyword">raise</span> ImproperlyConfigured(msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_rate</span>(<span class="params">self, rate</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Given the request rate string, return a two tuple of:</span></span><br><span class="line"><span class="string">        &lt;allowed number of requests&gt;, &lt;period of time in seconds&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> rate <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line">        num, period = rate.split(<span class="string">&#x27;/&#x27;</span>)  <span class="comment"># rate: &#x27;3/m&#x27; -&gt; &#x27;3&#x27;, &#x27;m&#x27;</span></span><br><span class="line">        num_requests = <span class="built_in">int</span>(num)</span><br><span class="line">        duration = &#123;<span class="string">&#x27;s&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;m&#x27;</span>: <span class="number">60</span>, <span class="string">&#x27;h&#x27;</span>: <span class="number">3600</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">86400</span>&#125;[period[<span class="number">0</span>]]  <span class="comment"># period取字符串索引0 min:m mmmmm:m</span></span><br><span class="line">        <span class="keyword">return</span> (num_requests, duration)  <span class="comment"># (3, 60)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Implement the check to see if the request should be throttled.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        On success calls `throttle_success`.</span></span><br><span class="line"><span class="string">        On failure calls `throttle_failure`.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.rate <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取key(IP userID ...)</span></span><br><span class="line">        self.key = self.get_cache_key(request, view)</span><br><span class="line">        <span class="keyword">if</span> self.key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># django缓存</span></span><br><span class="line">        <span class="comment"># 1. 导包：from django.core.cache import cache</span></span><br><span class="line">        <span class="comment"># 2. 添加缓存：cache.set(key, value, exp)</span></span><br><span class="line">        <span class="comment"># 3. 获取缓存： cache.get(key, default_value)</span></span><br><span class="line">        <span class="comment"># 初次访问缓存为空 self.history = [] 是存放时间的列表</span></span><br><span class="line">        self.history = self.cache.get(self.key, [])</span><br><span class="line">        <span class="comment"># 获取当前时间 存到self.now</span></span><br><span class="line">        self.now = self.timer()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Drop any requests from the history which have now passed the</span></span><br><span class="line">        <span class="comment"># throttle duration</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> self.history[-<span class="number">1</span>] &lt;= self.now - self.duration:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history) &gt;= self.num_requests:</span><br><span class="line">            <span class="keyword">return</span> self.throttle_failure()</span><br><span class="line">        <span class="keyword">return</span> self.throttle_success()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttle_success</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Inserts the current request&#x27;s timestamp along with the key</span></span><br><span class="line"><span class="string">        into the cache.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.history.insert(<span class="number">0</span>, self.now)</span><br><span class="line">        self.cache.<span class="built_in">set</span>(self.key, self.history, self.duration)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttle_failure</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Called when a request to the API has failed due to throttling.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns the recommended next request time in seconds.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 计算下一次访问需要等待的时间</span></span><br><span class="line">        <span class="keyword">if</span> self.history:</span><br><span class="line">            remaining_duration = self.duration - (self.now - self.history[-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            remaining_duration = self.duration</span><br><span class="line"></span><br><span class="line">        available_requests = self.num_requests - <span class="built_in">len</span>(self.history) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> available_requests &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> remaining_duration / <span class="built_in">float</span>(available_requests)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>继承SimpleRateThrottle自定义限制key</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> SimpleRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    SimpleRateThrottle 已经提供了其他方法 </span></span><br><span class="line"><span class="string">    只需要重写get_cache_key即可</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scope = <span class="string">&#x27;sss&#x27;</span>  <span class="comment"># scope配置限制的关键字</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="comment"># 该方法返回什么 就以什么为key -&gt; 以key来限制访问频率 key对应的value是一个时间列表</span></span><br><span class="line">        <span class="comment"># 这里返回客户端IP 就以IP限制访问次数</span></span><br><span class="line">        <span class="comment"># 如果返回一个固定值 所有人都共有一个key的限制 return xxx</span></span><br><span class="line">        print(<span class="string">&quot;IP&quot;</span>, request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>) </span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">自定义频率限制(IP user_id)</span></span><br><span class="line"><span class="string">  1. 继承SimpleRateThrottle</span></span><br><span class="line"><span class="string">  2. 重写get_cache_key 返回什么 就以什么为key进行限制(最好唯一 key对应的值是一个时间列表)</span></span><br><span class="line"><span class="string">  3. scope字段 需要与setting中对应 配置访问频率限制 &#x27;scope_name&#x27;: &#x27;5/m&#x27;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="内置的频率限制"><a href="#内置的频率限制" class="headerlink" title="内置的频率限制"></a>内置的频率限制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># drf默认配置</span></span><br><span class="line"><span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Throttling</span></span><br><span class="line"><span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;user&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;anon&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="AnonRateThrottle"><a href="#AnonRateThrottle" class="headerlink" title="AnonRateThrottle"></a>AnonRateThrottle</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">限制所有匿名未认证用户 使用IP区分用户</span></span><br><span class="line"><span class="string">使用DEFAULT_THROTTLE_RATES[&#x27;anon&#x27;] 来限制频次</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnonRateThrottle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Limits the rate of API calls that may be made by a anonymous users.</span></span><br><span class="line"><span class="string">    The IP address of the request will be used as the unique cache key.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scope = <span class="string">&#x27;anon&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Only throttle unauthenticated requests.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.cache_format % &#123;</span><br><span class="line">            <span class="string">&#x27;scope&#x27;</span>: self.scope,</span><br><span class="line">            <span class="string">&#x27;ident&#x27;</span>: self.get_ident(request)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="UserRateThrottle"><a href="#UserRateThrottle" class="headerlink" title="UserRateThrottle"></a>UserRateThrottle</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">限制认证用户 使用user id区分</span></span><br><span class="line"><span class="string">使用DEFAULT_THROTTLE_RATES[&#x27;user&#x27;] 来限制频次</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRateThrottle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Limits the rate of API calls that may be made by a given user.</span></span><br><span class="line"><span class="string">    The user id will be used as a unique cache key if the user is authenticated. For anonymous requests, the IP address of the request will be used.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scope = <span class="string">&#x27;user&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">            ident = request.user.pk</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ident = self.get_ident(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.cache_format % &#123;</span><br><span class="line">            <span class="string">&#x27;scope&#x27;</span>: self.scope,</span><br><span class="line">            <span class="string">&#x27;ident&#x27;</span>: ident</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ScopedRateThrottle"><a href="#ScopedRateThrottle" class="headerlink" title="ScopedRateThrottle"></a>ScopedRateThrottle</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">限制用户对于每个视图的访问频次 使用ip或者user id</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScopedRateThrottle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Limits the rate of API calls by different amounts for various parts of the API.  Any view that has the `throttle_scope` property set will be throttled.  The unique cache key will be generated by concatenating the user id of the request, and the scope of the view being accessed.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scope_attr = <span class="string">&#x27;throttle_scope&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Override the usual SimpleRateThrottle, because we can&#x27;t determine</span></span><br><span class="line">        <span class="comment"># the rate until called by the view.</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="comment"># We can only determine the scope once we&#x27;re called by the view.</span></span><br><span class="line">        self.scope = <span class="built_in">getattr</span>(view, self.scope_attr, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If a view does not have a `throttle_scope` always allow the request</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.scope:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Determine the allowed request rate as we normally would during</span></span><br><span class="line">        <span class="comment"># the `__init__` call.</span></span><br><span class="line">        self.rate = self.get_rate()</span><br><span class="line">        self.num_requests, self.duration = self.parse_rate(self.rate)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We can now proceed as normal.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().allow_request(request, view)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        If `view.throttle_scope` is not set, don&#x27;t apply this throttle.</span></span><br><span class="line"><span class="string">        Otherwise generate the unique cache key by concatenating the user id with the &#x27;.throttle_scope` property of the view.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">            ident = request.user.pk</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ident = self.get_ident(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.cache_format % &#123;</span><br><span class="line">            <span class="string">&#x27;scope&#x27;</span>: self.scope,</span><br><span class="line">            <span class="string">&#x27;ident&#x27;</span>: ident</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li><strong>限制匿名用户每分钟访问5次</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [<span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,],</span><br><span class="line">	<span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;5/m&#x27;</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用 second minute hour day来置命周期</span></span><br><span class="line"><span class="comment"># 可以全局使用 局部使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部使用 设置视图使用的频率限制类 访问频次仍在全局配置</span></span><br><span class="line">throttle_classes = [AnonRateThrottle]</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>限制登陆用户每分钟访问10次</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [<span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,],</span><br><span class="line">	<span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/m&#x27;</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以全局使用 局部使用</span></span><br><span class="line"><span class="comment"># 限制登陆用户 局限在于需要使用Django Amdin的那一套认证</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个频率类同时使用</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,                   <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">	<span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/m&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;5/m&#x27;</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>输出示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;detail&quot;</span>: <span class="string">&quot;Request was throttled. Expected available in 48 seconds.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="解析组件"><a href="#解析组件" class="headerlink" title="解析组件"></a>解析组件</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看下对应解析器源码即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认配置如下</span></span><br><span class="line"><span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.MultiPartParser&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h1 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h1><p><a target="_blank" rel="noopener" href="https://q1mi.github.io/Django-REST-framework-documentation/api-guide/filtering_zh/">Filtering</a></p>
<h2 id="过滤django-filter"><a href="#过滤django-filter" class="headerlink" title="过滤django-filter"></a>过滤django-filter</h2><p><a target="_blank" rel="noopener" href="https://q1mi.github.io/Django-REST-framework-documentation/api-guide/filtering_zh/#djangofilterbackenddjango">DjangoFilterBackend</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">对于列表数据 可能需要根据字段进行过滤 </span></span><br><span class="line"><span class="string">我们可以通过添加django-filter扩展来增强支持</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>使用</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不是drf内置 需要安装</span></span><br><span class="line">pip install django-<span class="built_in">filter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册app</span></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;django_filters&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置：在配置文件中增加过滤后端的配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [<span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在视图中添加filter_fields属性 指定可以过滤的字段</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bks</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line">    filter_fields = [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;price&#x27;</span>]  <span class="comment"># 配置可以按照哪个字段来过滤</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/bks/?price=8</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Django Admin管理其他Model</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app01.midels <span class="keyword">import</span> Book</span><br><span class="line"></span><br><span class="line">admin.site.register(Book)</span><br></pre></td></tr></table></figure>
<h2 id="排序OrderingFilter"><a href="#排序OrderingFilter" class="headerlink" title="排序OrderingFilter"></a>排序OrderingFilter</h2><p><a target="_blank" rel="noopener" href="https://q1mi.github.io/Django-REST-framework-documentation/api-guide/filtering_zh/#orderingfilter">OrderingFilter</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">在类视图中设置filter_backends 使用rest_frameworks.OrderingFilter过滤器 RESTframework会在请求的查询字符串参数中检查是否包含了ordering参数 如果包含了ordering参数 则按照ordering参数指明的排序字段对数据集进行排序</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">前端可以传递的ordering参数的可选字段值 需要在ordering_fields中声明</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> OrderingFilter</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bks</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line">    <span class="comment"># 因为局部配置回覆盖全局配置 所以需要重新把过滤组件核心类再次声明</span></span><br><span class="line">    <span class="comment"># 否则过滤功能会失效</span></span><br><span class="line">    filter_backends = [OrderingFilter, DjangoFilterBackend]  <span class="comment"># 局部配置</span></span><br><span class="line">    filter_fields = [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">    ordering_fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/bks/?ordering=-id</span></span><br><span class="line"><span class="comment"># -id 表示针对id字段进行倒叙排序</span></span><br><span class="line"><span class="comment"># id  表示针对id字段进行升序排序</span></span><br></pre></td></tr></table></figure>
<h2 id="搜索SearchFilter"><a href="#搜索SearchFilter" class="headerlink" title="搜索SearchFilter"></a>搜索SearchFilter</h2><p><a target="_blank" rel="noopener" href="https://q1mi.github.io/Django-REST-framework-documentation/api-guide/filtering_zh/#searchfilter">SearchFilter</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> OrderingFilter, SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bks</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    queryset = Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookSerializer</span><br><span class="line">    filter_backends = [SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;=price&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/bks/?search=8.00</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">默认情况下 搜索将使用不区分大小写的部分匹配 搜索参数可以包含多个搜索项 其应该是空格和/或逗号分隔</span></span><br><span class="line"><span class="string">如果使用多个搜索术语 则仅当所有提供的术语都匹配时才在列表中返回对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可以通过在search_fields前面添加各种字符来限制搜索行为</span></span><br><span class="line"><span class="string">&#x27;^&#x27; 以指定内容开始</span></span><br><span class="line"><span class="string">&#x27;=&#x27; 完全匹配</span></span><br><span class="line"><span class="string">&#x27;@&#x27; 全文搜索(目前只支持Django的MySQL后端)</span></span><br><span class="line"><span class="string">&#x27;$&#x27; 正则搜索</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只要出异常 按照固定的信息返回</span></span><br><span class="line"><span class="comment"># 就算出错 我们也要返回json数据 然后再里面提示error信息</span></span><br></pre></td></tr></table></figure>
<h2 id="异常处理部分源码"><a href="#异常处理部分源码" class="headerlink" title="异常处理部分源码"></a>异常处理部分源码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dispath方法 做了异常捕获</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        .../</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exception handling</span></span><br><span class="line"><span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;rest_framework.views.exception_handler&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;NON_FIELD_ERRORS_KEY&#x27;</span>: <span class="string">&#x27;non_field_errors&#x27;</span>,</span><br><span class="line">    </span><br><span class="line"><span class="comment"># exception_handler异常处理源码</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Returns the response that should be used for any given exception. By default we handle the REST framework `APIException`, and also Django&#x27;s built-in `Http404` and `PermissionDenied` exceptions. Any unhandled exceptions may return `None`, which will cause a 500 error to be raised.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(exc, Http404):</span><br><span class="line">        exc = exceptions.NotFound()</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(exc, PermissionDenied):</span><br><span class="line">        exc = exceptions.PermissionDenied()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(exc, exceptions.APIException):</span><br><span class="line">        headers = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(exc, <span class="string">&#x27;auth_header&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            headers[<span class="string">&#x27;WWW-Authenticate&#x27;</span>] = exc.auth_header</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(exc, <span class="string">&#x27;wait&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            headers[<span class="string">&#x27;Retry-After&#x27;</span>] = <span class="string">&#x27;%d&#x27;</span> % exc.wait</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(exc.detail, (<span class="built_in">list</span>, <span class="built_in">dict</span>)):</span><br><span class="line">            data = exc.detail</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = &#123;<span class="string">&#x27;detail&#x27;</span>: exc.detail&#125;</span><br><span class="line"></span><br><span class="line">        set_rollback()</span><br><span class="line">        <span class="keyword">return</span> Response(data, status=exc.status_code, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 没有处理的异常返回None 引发500 Error</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># raise_uncaught_exception</span></span><br><span class="line"><span class="keyword">if</span> response <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    self.raise_uncaught_exception(exc)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_uncaught_exception</span>(<span class="params">self, exc</span>):</span></span><br><span class="line">    <span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">        .../</span><br><span class="line">    <span class="keyword">raise</span> exc  <span class="comment"># 未处理的异常 直接raise</span></span><br></pre></td></tr></table></figure>
<h2 id="自定义异常处理方法"><a href="#自定义异常处理方法" class="headerlink" title="自定义异常处理方法"></a>自定义异常处理方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">自定义异常处理 </span></span><br><span class="line"><span class="string">  1. 处理drf未处理的异常</span></span><br><span class="line"><span class="string">  2. 记录错误日志</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">自定义：统一接口的返回</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义异常处理方法</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    两种情况</span></span><br><span class="line"><span class="string">      1. None drf没有处理</span></span><br><span class="line"><span class="string">      2. Response对象</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">        <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;status&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;msg&#x27;</span>: <span class="built_in">str</span>(exc)&#125;, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">    <span class="comment"># return response</span></span><br><span class="line">    <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;status&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;msg&#x27;</span>: response.data.get(<span class="string">&#x27;detail&#x27;</span>)&#125;, status=response.status_code)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">如果需要分得更细 再去捕获判断：</span></span><br><span class="line"><span class="string">if isinstance(exc, ZeroDivisionError):</span></span><br><span class="line"><span class="string">	pass</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string"># 替换为自定义响应对象</span></span><br><span class="line"><span class="string">return APIResponse(code=0, msg=&#x27;error&#x27;, result=str(exc))</span></span><br><span class="line"><span class="string">return APIResponse(code=0, msg=&#x27;error&#x27;, result=ret.data)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="书籍管理接口详细"><a href="#书籍管理接口详细" class="headerlink" title="书籍管理接口详细"></a>书籍管理接口详细</h1><h2 id="模型类"><a href="#模型类" class="headerlink" title="模型类"></a>模型类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># auto_now_add=True 只要记录创建 不需要手动插入时间 自动把当前时间插入</span></span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># auto_now=True 只要更新 就会把当前时间插入</span></span><br><span class="line">    last_update_time = models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># import datetime</span></span><br><span class="line">    <span class="comment"># datetime.datetime.now一定不要加()执行 否则时间都是项目创建的时间</span></span><br><span class="line">    <span class="comment"># create_time = models.DateTimeField(default=datetime.datetime.now)</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 单个字段有索引:db_index=True 有唯一:unique=True 直接配在字段参数中</span></span><br><span class="line">        <span class="comment"># 多个字段 有联合索引:index_together 联合唯一:unique_together</span></span><br><span class="line">        abstract = <span class="literal">True</span>  <span class="comment"># 抽象表 不在数据库中建立表</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># help_text admin管理后台的网页提示</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">&#x27;书名&#x27;</span>, help_text=<span class="string">&#x27;这里填书名&#x27;</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">8</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 一对多的关系一但确立 关联字段写在多的一方</span></span><br><span class="line">    <span class="comment"># to_field 默认不屑 关联到主键</span></span><br><span class="line">    <span class="comment"># db_constraint=False 控制是否应该在数据库中为这个外键创建一个约束 默认值是True</span></span><br><span class="line">    publish = models.ForeignKey(to=<span class="string">&#x27;Publish&#x27;</span>, on_delete=models.DO_NOTHING, db_constraint=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对对多 跟作者 关联字段写在查询次数多的一方</span></span><br><span class="line">    <span class="comment"># 三种创建方式 根据实际选取选择</span></span><br><span class="line">    <span class="comment"># 第三张表 只有关联字段 用自动创建</span></span><br><span class="line">    <span class="comment"># 第三张表 有扩展字段 需要手动写</span></span><br><span class="line">    authors = models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>, db_constraint=<span class="literal">False</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name_plural = <span class="string">&#x27;书籍&#x27;</span>  <span class="comment"># admin中显示</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">publish_name</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.publish.name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">author_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> [&#123;<span class="string">&#x27;name&#x27;</span>: author.name, <span class="string">&#x27;gender&#x27;</span>: author.get_gender_display()&#125; <span class="keyword">for</span> author <span class="keyword">in</span> self.authors.<span class="built_in">all</span>()]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publish</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    addr = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    gender = models.IntegerField(choices=((<span class="number">1</span>, <span class="string">&#x27;男&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;女&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;其他&#x27;</span>)))</span><br><span class="line">    <span class="comment"># 一对一关系 写在查询频率高的以方</span></span><br><span class="line">    <span class="comment"># OneToOneField的本质就是ForeignKey+unique=True</span></span><br><span class="line">    authordetail = models.OneToOneField(to=<span class="string">&#x27;AuthorDetail&#x27;</span>, db_constraint=<span class="literal">False</span>, on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorDetail</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    phone = models.CharField(max_length=<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># on_delete</span></span><br><span class="line"><span class="string">models.CASCADE</span></span><br><span class="line"><span class="string">  删除关联数据 与之关联也删除</span></span><br><span class="line"><span class="string">models.DO_NOTHING</span></span><br><span class="line"><span class="string">  删除关联数据 引发错误IntegrityError</span></span><br><span class="line"><span class="string">  不采取任何行动 如果你的数据库后端强制执行引用完整性 这将导致一个 IntegrityError</span></span><br><span class="line"><span class="string">models.PROTECT</span></span><br><span class="line"><span class="string">  删除关联数据 引发错误ProtectedError</span></span><br><span class="line"><span class="string">models.SET_NULL</span></span><br><span class="line"><span class="string">  删除关联数据 与之关联的值设置null(前提是FK字段需要设置可为空)</span></span><br><span class="line"><span class="string">models.SET_DEFAULT</span></span><br><span class="line"><span class="string">  删除关联数据 与之关联的值设置为默认值(前提FK字段需要设置默认值)</span></span><br><span class="line"><span class="string">models.SET</span></span><br><span class="line"><span class="string">  删除关联数据</span></span><br><span class="line"><span class="string">  1. 与之关联的值设置为指定值 设置：models.SET(值)</span></span><br><span class="line"><span class="string">  2. 与之关联的值设置为可执行对象的返回值 设置：models.SET(可执行对象)</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"># 表断关联</span></span><br><span class="line"><span class="string">  1. 表之间没有外键关联 但是有外键逻辑关联(有外键字段 没有设置约束) db_constraint</span></span><br><span class="line"><span class="string">  2. 断关联后不会影响数据库查询效率 但是会极大的提高数据库增删改效率(不影响增删改查操作)</span></span><br><span class="line"><span class="string">  3. 断关联一定要通过逻辑保证表之间数据的安全 不要出现脏数据(代码控制)</span></span><br><span class="line"><span class="string">  4. 断关联</span></span><br><span class="line"><span class="string">  5. 级联关系</span></span><br><span class="line"><span class="string">     作者没了 详情也没：on_delete=models.CASCADE</span></span><br><span class="line"><span class="string">     出版社没了 书还是哪个出版社出版：on_delete=models.DO_NOTHING</span></span><br><span class="line"><span class="string">     部门没了 员工没有部门(空部门)：null=True, on_delete=models.SET_NULL</span></span><br><span class="line"><span class="string">     部门没了 员工进入默认部门(默认值)：default=0, on_delete=models.SET_DEFAULT</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="CBV视图"><a href="#CBV视图" class="headerlink" title="CBV视图"></a>CBV视图</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 查所有</span></span><br><span class="line">        books = models.Book.objects.<span class="built_in">all</span>().<span class="built_in">filter</span>(is_delete=<span class="literal">False</span>)</span><br><span class="line">        serializer = serializers.BookModelSerializer(books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="comment"># 查一个 取pk实现</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;具备增单条 和增多条的功能&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(request.data, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="comment"># 增单条</span></span><br><span class="line">            serializer = serializers.BookModelSerializer(data=request.data)</span><br><span class="line">            serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(request.data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="comment"># 增多条 现在serializer类型为：ListSerialzer</span></span><br><span class="line">            serializer = serializers.BookModelSerializer(data=request.data, many=<span class="literal">True</span>)</span><br><span class="line">            print(<span class="built_in">type</span>(serializer))</span><br><span class="line">            serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            新增 -&gt; ListSerializer.save() -&gt; create()</span></span><br><span class="line"><span class="string">            def create(self, validated_data):</span></span><br><span class="line"><span class="string">                return [self.child.create(attrs) for attrs in validated_data]</span></span><br><span class="line"><span class="string">            增多条：循环新增</span></span><br><span class="line"><span class="string">            self.child: BookModelSerialzer</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 改一个</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.get(<span class="string">&#x27;pk&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            book = models.Book.objects.<span class="built_in">filter</span>(pk=kwargs.get(<span class="string">&#x27;pk&#x27;</span>)).first()</span><br><span class="line">            <span class="comment"># partial=True允许局部更新</span></span><br><span class="line">            serializer = serializers.BookModelSerializer(book, data=request.data, partial=<span class="literal">True</span>)</span><br><span class="line">            serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 修改多个 需要新建一个BookListSerializer 并重写 update()方法</span></span><br><span class="line">            <span class="comment"># 规定数据格式：request.data: [&#123;id:1, name=xx, price:xxx&#125;, &#123;id:2, name=xx, price:xxx&#125;,]</span></span><br><span class="line">            <span class="comment"># 处理传入的数据：对象列表[book1, book2] 修改的数据列表：[&#123;name:xx,price:xx&#125;, &#123;&#125;]</span></span><br><span class="line">            <span class="comment"># 方案1：for循环一个个修改</span></span><br><span class="line">            <span class="comment"># 方案2：重写ListSerializer的update方法</span></span><br><span class="line">            book_list = []</span><br><span class="line">            modify_data = []</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> request.data:</span><br><span class="line">                pk = item.pop(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">                book = models.Book.objects.get(pk=pk)</span><br><span class="line">                book_list.append(book)</span><br><span class="line">                modify_data.append(item)</span><br><span class="line">            <span class="comment"># 第一种方案 for循环实现</span></span><br><span class="line">            <span class="comment"># for k, v in enumerate(modify_data):</span></span><br><span class="line">            <span class="comment">#     serializer = serializers.BookModelSerializer(book_list[k], data=v)</span></span><br><span class="line">            <span class="comment">#     serializer.is_valid(raise_exception=True)</span></span><br><span class="line">            <span class="comment">#     serializer.save()  # 调ListSerializer的update方法 改到自己的</span></span><br><span class="line">            <span class="comment"># return Response(&#x27;succ&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 第二种方案 重写ListSerializer的update()</span></span><br><span class="line">            serializer = serializers.BookModelSerializer(instance=book_list, data=modify_data, many=<span class="literal">True</span>)</span><br><span class="line">            serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            serializer.save()  <span class="comment"># 调ListSerializer的update方法 改到自己的</span></span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 单个删除 和批量删除</span></span><br><span class="line">        pk = kwargs.get(<span class="string">&#x27;pk&#x27;</span>)</span><br><span class="line">        pks = []</span><br><span class="line">        <span class="keyword">if</span> pk:</span><br><span class="line">            <span class="comment"># 单条删除</span></span><br><span class="line">            pks.append(pk)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 不管单条删除还是多条删除 都用多条删除</span></span><br><span class="line">            <span class="comment"># 多条删除 &#123;&#x27;pks&#x27;: [1, 2, 3]&#125;</span></span><br><span class="line">            pks = request.data.get(<span class="string">&#x27;pks&#x27;</span>)</span><br><span class="line">        <span class="comment"># 把id_delete设置为True</span></span><br><span class="line">        <span class="comment"># res返回受影响的行数</span></span><br><span class="line">        res = models.Book.objects.<span class="built_in">filter</span>(pk__in=pks, is_delete=<span class="literal">False</span>).update(is_delete=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> res:</span><br><span class="line">            <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;删除成功 删除%s条数据&#x27;</span> % res&#125;)</span><br><span class="line">        <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;没有要删除的数据&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="序列化器-1"><a href="#序列化器-1" class="headerlink" title="序列化器"></a>序列化器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写一个类 继承ListSerializer 重写update</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListSerialzier</span>(<span class="params">serializers.ListSerializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().create(validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        print(instance)</span><br><span class="line">        print(validated_data)</span><br><span class="line">        <span class="comment"># 保存数据</span></span><br><span class="line">        <span class="comment"># self.child: 是BookModelSerializer对象</span></span><br><span class="line">        <span class="comment"># return [self.child.update(对象, 字典) for attrs in validated_data]</span></span><br><span class="line">        <span class="keyword">return</span> [self.child.update(instance[i], attrs) <span class="keyword">for</span> i, attrs <span class="keyword">in</span> <span class="built_in">enumerate</span>(validated_data)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果序列化的是数据库的表 尽量用ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># 关联字段显示name</span></span><br><span class="line">    <span class="comment"># 第一种方案：source(只序列化可以 反序列化有问题)</span></span><br><span class="line">    <span class="comment"># publish = serializers.CharField(source=&#x27;publish.name&#x27;)</span></span><br><span class="line">    <span class="comment"># 第二种方案：models中写方法 也可以使用SerializerMethodField字段</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># many=True的时候 用这个类实例化(源码)</span></span><br><span class="line">        list_serializer_class = BookListSerialzier</span><br><span class="line">        model = models.Book</span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;</span></span><br><span class="line">        <span class="comment"># 联表嵌套深度 用得少</span></span><br><span class="line">        <span class="comment"># depth = 0</span></span><br><span class="line">        <span class="comment"># fields = (&#x27;name&#x27;, &#x27;price&#x27;, &#x27;authors&#x27;, &#x27;publish&#x27;)</span></span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;authors&#x27;</span>, <span class="string">&#x27;author_list&#x27;</span>, <span class="string">&#x27;publish&#x27;</span>, <span class="string">&#x27;publish_name&#x27;</span>)</span><br><span class="line">        read_only_fileds = (<span class="string">&#x27;publish_name&#x27;</span>, <span class="string">&#x27;author_list&#x27;</span>)</span><br><span class="line">        extra_kwargs = &#123;</span><br><span class="line">            <span class="string">&#x27;publish&#x27;</span>: &#123;<span class="string">&#x27;write_only&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;authors&#x27;</span>: &#123;<span class="string">&#x27;write_only&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="序列化-1"><a href="#序列化-1" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">序列化输出结果</span></span><br><span class="line"><span class="string">由于设置 read_only 和 write_only字段</span></span><br><span class="line"><span class="string">序列化只展示read_only字段 不展示write_only字段</span></span><br><span class="line"><span class="string">反序列化需要给write_only字段 不需要给read_only字段</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Python&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="string">&quot;131.88&quot;</span>,</span><br><span class="line">        <span class="string">&quot;author_list&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;minho&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;kimi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;女&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;publish_name&quot;</span>: <span class="string">&quot;南京出版社&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;js&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="string">&quot;78.00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;author_list&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;kimi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;女&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;publish_name&quot;</span>: <span class="string">&quot;东京出版社&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># source参数可以更改关系字段显示名字 </span></span><br><span class="line"><span class="comment"># 但是反序列化会报错</span></span><br><span class="line">The `.create()` method does <span class="keyword">not</span> support writable dotted-source fields by default.</span><br><span class="line">Write an explicit `.create()` method <span class="keyword">for</span> serializer `api.serializers.BookModelSerializer`, <span class="keyword">or</span> <span class="built_in">set</span> `read_only=<span class="literal">True</span>` on dotted-source serializer fields.</span><br></pre></td></tr></table></figure>
<h3 id="反序列化-1"><a href="#反序列化-1" class="headerlink" title="反序列化"></a>反序列化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">反序列化传入json数据 提交post</span></span><br><span class="line"><span class="string">注意：此时反序列化关系字段为 authors[id] 和 publish(id)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;数据结构&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="string">&quot;99.00&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authors&quot;</span>: [<span class="number">2</span>],</span><br><span class="line">    <span class="string">&quot;publish&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># book其实是5个表(自动生成多对多关系表)</span></span><br><span class="line">  - 一对一关系 其实是ForeignKey uniqe=<span class="literal">True</span></span><br><span class="line">  - on_delete: 级联删除 设置为空 什么都不干 设置成默认值</span><br><span class="line">  - 联合索引 联合唯一</span><br><span class="line">  - 日期类型参数：auto_now_add 和 auto_now</span><br><span class="line">  - 基表：abstract</span><br><span class="line"></span><br><span class="line"><span class="comment"># book</span></span><br><span class="line">  - 单条查询 批量查询(判断kwargs.get(<span class="string">&#x27;pk&#x27;</span>)处理)</span><br><span class="line">  - 单条新增 批量新增(生成序列化对象 many=True -&gt; ListSerializer -&gt; 循环掉self.child.save)</span><br><span class="line">  - 单条修改 批量修改(自定义BookListSerializer 继承ListSerializer: 重写update方法 因为ListSerizlizer没有实现)</span><br><span class="line">           <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">               <span class="comment"># many=True的时候 用这个类实例化(源码)</span></span><br><span class="line">               list_serializer_class = BookListSerialzier  <span class="comment"># 关联自定义BookListSerializer</span></span><br><span class="line">  - 单条删除 批量删除(is_delete) 同一用批量删除 pk__in=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<h1 id="分页器"><a href="#分页器" class="headerlink" title="分页器"></a>分页器</h1><p><strong>drf内置三个分页器</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> CursorPagination</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def默认配置</span></span><br><span class="line"><span class="string">  DEFAULT_PAGINATION_CLASS: None  # 默认不分页</span></span><br><span class="line"><span class="string">  PAGE_SIZE: None  # 每页显示数目 配置分页需要配置此参数才能生效</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 局部配置分页</span></span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line">    queryset = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = serializers.BookModelSerializer</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 如何使用APIView分页</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 实例化得到一个分页器对象</span></span><br><span class="line">        books = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        page_cursor = MyPageNumberPagination()</span><br><span class="line">        <span class="comment"># paginate_queryset进去筛选数据</span></span><br><span class="line">        books = page_cursor.paginate_queryset(books, request, view=self)</span><br><span class="line">        <span class="comment"># 得到上一页下一页的url</span></span><br><span class="line">        next_url = page_cursor.get_next_link()</span><br><span class="line">        prev_url = page_cursor.get_previous_link()</span><br><span class="line">        print(next_url)</span><br><span class="line">        print(prev_url)</span><br><span class="line">        serializer = serializers.BookModelSerializer(books, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<h2 id="PageNumberPagination"><a href="#PageNumberPagination" class="headerlink" title="PageNumberPagination"></a>PageNumberPagination</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 页码分页 基本分页</span></span><br><span class="line"><span class="comment"># 继承 并配置4个重要参数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span>                   <span class="comment"># 默认每页显示数量</span></span><br><span class="line">    page_query_param = <span class="string">&#x27;aaa&#x27;</span>        <span class="comment"># /api/books2/?aaa=2 查询key</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># /api/books2/?aaa=2&amp;size=5 每页显示条数</span></span><br><span class="line">    max_page_size = <span class="number">5</span>               <span class="comment"># 每页最大显示数量 配合上一个参数</span></span><br></pre></td></tr></table></figure>
<h2 id="LimitOffsetPagination"><a href="#LimitOffsetPagination" class="headerlink" title="LimitOffsetPagination"></a>LimitOffsetPagination</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 偏移分页</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLimitOffsetPagination</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">    default_limit = <span class="number">3</span>              <span class="comment"># 默认每页显示数量</span></span><br><span class="line">    limit_query_param = <span class="string">&#x27;limit&#x27;</span>    <span class="comment"># 每页数量</span></span><br><span class="line">    offset_query_param = <span class="string">&#x27;offset&#x27;</span>  <span class="comment"># 偏移位置</span></span><br><span class="line">    max_limit = <span class="number">200</span>                <span class="comment"># limit最大可以设置数量</span></span><br></pre></td></tr></table></figure>
<h2 id="CursorPagination"><a href="#CursorPagination" class="headerlink" title="CursorPagination"></a>CursorPagination</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 效率高 只能选择往前走 或者往后走(只有上一页下一页)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCursorPagination</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span>  <span class="comment"># 查询参数</span></span><br><span class="line">    page_size = <span class="number">3</span>                  <span class="comment"># 每页显示的条数</span></span><br><span class="line">    ordering = <span class="string">&#x27;-id&#x27;</span>               <span class="comment"># 排序字段 默认-created 没有该字段需要修改配置</span></span><br></pre></td></tr></table></figure>
<h1 id="自动生成接口文档"><a href="#自动生成接口文档" class="headerlink" title="自动生成接口文档"></a>自动生成接口文档</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf可以自动帮助我们生成接口文档</span></span><br><span class="line"><span class="comment"># 接口文档以网页的方式呈现</span></span><br><span class="line"><span class="comment"># 自动接口文档生成的是继承自 APIView 及其子类的视图 ** </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外了解：swagger</span></span><br></pre></td></tr></table></figure>
<h2 id="安装coreapi"><a href="#安装coreapi" class="headerlink" title="安装coreapi"></a>安装coreapi</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf生成接口文档需要coreapi库的支持</span></span><br><span class="line">pip install coreapi</span><br></pre></td></tr></table></figure>
<h2 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置路由</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> rest_framework.documentation <span class="keyword">import</span> include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&#x27;docs/&#x27;</span>, include_docs_urls(title=<span class="string">&#x27;API文档&#x27;</span>))</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 报错: AttributeError: &#x27;AutoSchema&#x27; object has no attribute &#x27;get_link&#x27;</span></span><br><span class="line"><span class="comment"># 在settings.py添加配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.schemas.coreapi.AutoSchema&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="文档描述说明的定义位置"><a href="#文档描述说明的定义位置" class="headerlink" title="文档描述说明的定义位置"></a>文档描述说明的定义位置</h2><h3 id="单一方法的视图"><a href="#单一方法的视图" class="headerlink" title="单一方法的视图"></a>单一方法的视图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单一方法的视图 可以直接使用类视图的文档字符串</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListView</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;返回所有图书信息&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="多个方法的视图"><a href="#多个方法的视图" class="headerlink" title="多个方法的视图"></a>多个方法的视图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 包含多个方法的视图 在类视图的文档字符串中 分开方法定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListView</span>(<span class="params">ListAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">    返回所有图书信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    post:</span></span><br><span class="line"><span class="string">    新增图书</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="视图集ViewSet-1"><a href="#视图集ViewSet-1" class="headerlink" title="视图集ViewSet"></a>视图集ViewSet</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于视图集 仍在类视图的文档字符串中分开定义 但是应该使用action名称区分</span></span><br><span class="line"><span class="comment"># 视图及ViewSet中的retrieve名称 在接口文档网站中叫做read</span></span><br><span class="line"><span class="comment"># 参数的Description需要在模型类或序列化类的字段中以help_text选项定义</span></span><br><span class="line"><span class="comment"># verbose_name help_text</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">    返回图书列表数据</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">    返回图书详情数据</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    latest:</span></span><br><span class="line"><span class="string">    返回最新的图书数据</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    read:</span></span><br><span class="line"><span class="string">    修改图书的阅读量</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="JWT认证"><a href="#JWT认证" class="headerlink" title="JWT认证"></a>JWT认证</h1><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JsonWebToken入门教程</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在用户注册或登录后 我们想记录用户的登录状态 或者为用户创建身份认证的凭证 我们不在使用Session认证机制 而是用Json Web Token(本质就是token)认证机制</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">JsonWebToken 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准(RFE 7519) 该token被设计为紧凑且用于分布式站点的单点登录(SSO)场景 </span></span><br><span class="line"><span class="string">JWT的声明一般被用来在身份提供者和服务者间传递被认证的用户身份信息 以便于从资源服务器获取资源 也可以额外的增加一些其他业务逻辑所必须的声明信息 该token页可以直接被用于认证 也可被加密</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">不能被篡改 但是你可以拿出来用 只要没有你过期 -&gt; 爬虫</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="JWT数据结构"><a href="#JWT数据结构" class="headerlink" title="JWT数据结构"></a>JWT数据结构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三段信息</span></span><br><span class="line">Header.Payload.Signature</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Header    -  头部</span></span><br><span class="line"><span class="string">Payload   -  负载</span></span><br><span class="line"><span class="string">Signature - 签名</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原理</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. JWT分三段式：Header.Payload.Signature</span></span><br><span class="line"><span class="string">2. 头和体是可逆加密 让服务器可以反解出user对象 签名是不可逆加密 保证整个token的安全性</span></span><br><span class="line"><span class="string">3. 头体签名有三部分 都是采用json格式的字符串进行加密 可逆加密一般采用base64算法 不可逆加密一般采用hash(md5)算法</span></span><br><span class="line"><span class="string">4. Header中的内容是基本信息：公司信息 项目组信息 token采用的加密方式信息</span></span><br><span class="line"><span class="string">5. Payload中的内容是关键信息：用户主键 用户名 签发时客户端信息(设备号 地址) 过期时间</span></span><br><span class="line"><span class="string">6. Signature中的内容时安全信息：头的加密结果 + 体的加密结果 + 服务器不对外公开的安全码进行加密</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Header 部分是一个JSON 对象 描述JWT的元数据 通常是下面的样子:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">上面代码中 </span></span><br><span class="line"><span class="string">  alg属性表示签名的算法(algorithm) 默认是 HMAC SHA256(写成 HS256)</span></span><br><span class="line"><span class="string">  typ属性表示这个令牌(token) 的类型(type) JWT令牌统一写为JWT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  最后 将上面的 JSON对象使用 Base64URL算法 转成字符串</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Payload部分也是一个JSON对象 用来存放实际需要传递的数据 JWT规定了7个官方字段 供选用</span></span><br><span class="line">iss (issuer)：签发人</span><br><span class="line">exp (expiration time)：过期时间</span><br><span class="line">sub (subject)：主题</span><br><span class="line">aud (audience)：受众</span><br><span class="line">nbf (Not Before)：生效时间</span><br><span class="line">iat (Issued At)：签发时间</span><br><span class="line">jti (JWT ID)：编号</span><br><span class="line"></span><br><span class="line"><span class="comment"># 除了官方字段 你还可以在这个部分定义私有字段 比如：</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;admin&quot;</span>: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">注意 JWT默认是不加密的 任何人都可以读到 所以不要把秘密信息放在这个部分</span></span><br><span class="line"><span class="string">这个JSON对象也要使用 Base64URL算法 转成字符串</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Signature 部分是对前两部分的签名 防止数据篡改</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  首先 需要指定一个密钥(secret) 这个密钥只有服务器才知道 不能泄露给用户</span></span><br><span class="line"><span class="string">  然后 用Header里面指定的签名算法(默认是 HMAC SHA256) 按照下面的公式产生签名</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 算出签名以后 把Header Payload Signature三个部分拼成一个字符串 每个部分之间用&quot;点&quot;(.)分隔 就可以返回给用户</span></span><br></pre></td></tr></table></figure>
<h3 id="Base64URL"><a href="#Base64URL" class="headerlink" title="Base64URL"></a>Base64URL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">前面提到 Header和Payload串型化的算法是 Base64URL 这个算法跟Base64算法基本类似 但有一些小的不同</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">JWT 作为一个令牌(token) 有些场合可能会放到URL</span></span><br><span class="line"><span class="string">  比如 api.example.com/?token=xxx</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">Base64有三个字符 -&gt; + / =  在URL里面有特殊含义 所以要被替换掉 </span></span><br><span class="line"><span class="string">  =被省略</span></span><br><span class="line"><span class="string">  +替换成-</span></span><br><span class="line"><span class="string">  /替换成_ </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">这就是 Base64URL算法</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="检验"><a href="#检验" class="headerlink" title="检验"></a>检验</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. 将token按 . 拆分为三个字符串 第一段：头加密字符串 一般不需要做任何处理</span></span><br><span class="line"><span class="string">2. 第二段 体加密字符串 要反解出用户主键 通过主键从User表中就能得到登录用户 过期时间和设备信息都是安全信息 确保token没有过期 且是同一设备来的</span></span><br><span class="line"><span class="string">3. 再用第一段 + 第二段 + 服务器安全码 不可逆hash(md5等)加密 与第三段签名字符串进行碰撞校验 通过后才能代表第二段校验得到的user对象就是合法的登录用户</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="DRF项目的JWT认证开发流程"><a href="#DRF项目的JWT认证开发流程" class="headerlink" title="DRF项目的JWT认证开发流程"></a>DRF项目的JWT认证开发流程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. 用账号密码访问登录接口 登录接口逻辑中掉用签发token算法 得到token 返回给客户端 客户端自己存到cookies中</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 校验token的算法应该写在认证类(在认证类中调用) 全局配置给认证组件 所有视图函数类请求 都会进行认证校验 所以请求带token过来 就会反解出user对象 在视图类中用request.user就能访问登录的用户</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注：登录接口需要做 认证 + 权限 两个局部禁用</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="第三方JWT的使用"><a href="#第三方JWT的使用" class="headerlink" title="第三方JWT的使用"></a>第三方JWT的使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官网</span></span><br><span class="line">https://jpadilla.github.io/django-rest-framework-jwt/</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第三方写好的</span></span><br><span class="line">pip install djangorestframework-jwt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. 基于django的Auth模块</span></span><br><span class="line"><span class="string">2. 使用自己的认证模块</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="继承DjangoUser表扩展"><a href="#继承DjangoUser表扩展" class="headerlink" title="继承DjangoUser表扩展"></a>继承DjangoUser表扩展</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">继承django 原生的User表 最好一开始就使用</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 继承AbstractUser表 扩展字段</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">AbstractUser</span>):</span></span><br><span class="line">    phone = models.CharField(max_length=<span class="number">11</span>)</span><br><span class="line">    icon = models.ImageField(upload_to=<span class="string">&#x27;icon&#x27;</span>, default=<span class="string">&#x27;icon/default.png&#x27;</span>)  <span class="comment"># ImageField依赖pillow模块</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># settings.py配置</span></span><br><span class="line"><span class="comment"># 扩展django自带的user表 </span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">&#x27;api.User&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 配置头像相关</span></span><br><span class="line">MEDIA_URL = <span class="string">&#x27;/media/&#x27;</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;media&#x27;</span>)</span><br><span class="line"><span class="comment"># 开发MEDIA文件</span></span><br><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve  <span class="comment"># django内置给你的一个视图函数 类似默认开了static静态文件的路由</span></span><br><span class="line"><span class="keyword">from</span> django,urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings  <span class="comment"># 以后取配置文件都用这个 内置 比较全</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">&#x27;media/?P&lt;path&gt;.*&#x27;</span>, serve, &#123;<span class="string">&#x27;document_root&#x27;</span>: settings.MEDIA_ROOT&#125;)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行数据库迁移</span></span><br><span class="line"><span class="comment"># 创建超级用户 进行测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 国际化</span></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-Hans&#x27;</span></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line">USE_TZ = <span class="literal">False</span>  <span class="comment"># 时区</span></span><br></pre></td></tr></table></figure>
<h4 id="登录认证简单使用"><a href="#登录认证简单使用" class="headerlink" title="登录认证简单使用"></a>登录认证简单使用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> JSONWebTokenAPIView  <span class="comment"># 基类 继承APIView</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 都继承JSONWebTokenAPIView</span></span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> ObtainJSONWebToken</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> RefreshJSONWebToken</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> VerifyJSONWebToken</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. urls.py配置路由即可简单快速使用登录接口获取jwt token</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> ObtainJSONWebToken</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;login/&#x27;</span>, ObtainJSONWebToken.as_view()),  <span class="comment"># 正确登录获取jwt token</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. views.py 局部使用jwt认证</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> JSONWebTokenAuthentication</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookBiew</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication]  <span class="comment"># 局部配置jwt认证</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        print(request.user, request.user.email)</span><br><span class="line">        print(request.auth)</span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 在请求headers带认证参数 否则为匿名用户AnonymousUser(return None)</span></span><br><span class="line">Authorization JWT jwt_value</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">注意：这个时候 如果请求headers中不带认证参数 源码直接return None 相当于匿名用户AnonymousUser访问</span></span><br><span class="line"><span class="string">     这个时候 如果视图函数允许匿名用户访问 那么此时不带jwt token也可以访问成功</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string">可以通过通过认证类：JSONWebTokenAuthentication 和权限类：IsAuthenticated 来控制用户登录以后才能访问某些接口</span></span><br><span class="line"><span class="string">如果用户不等录就可以访问 只需要把权限类：IsAuthenticated去掉即可</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 禁止匿名用户访问</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookBiew</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication]</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置权限 IsAuthenticated 只允许认证通过的用户访问&quot;&quot;&quot;</span></span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="自定制JWT认证去除headers前缀"><a href="#自定制JWT认证去除headers前缀" class="headerlink" title="自定制JWT认证去除headers前缀"></a>自定制JWT认证去除headers前缀</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义重写jwt认证类 重写get_jwt_value方法 去掉认证前缀 JWT token.xx.xx</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> HTTP_HEADER_ENCODING</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> JSONWebTokenAuthentication</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyToken</span>(<span class="params">JSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_jwt_value</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        auth = request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(auth, <span class="built_in">str</span>):</span><br><span class="line">            auth = auth.encode(HTTP_HEADER_ENCODING)</span><br><span class="line">        <span class="keyword">return</span> auth</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 视图函数局部配置</span></span><br><span class="line">authentication_classes = [MyToken]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 除此之外 还可以修改前缀 settings.py</span></span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="comment"># &#x27;JWT_AUTH_HEADER_PREFIX&#x27;: &#x27;JWT&#x27;,  JWT自带配置 认证请求headrs需要带前缀</span></span><br><span class="line">    <span class="string">&#x27;JWT_AUTH_HEADER_PREFIX&#x27;</span>: <span class="string">&#x27;aaa&#x27;</span>,  <span class="comment"># aaa token.xx.xx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="手动签发JWT"><a href="#手动签发JWT" class="headerlink" title="手动签发JWT"></a>手动签发JWT</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以拥有原生登录基于Model类user对象签发JWT</span></span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.settings <span class="keyword">import</span> api_settings</span><br><span class="line"></span><br><span class="line">jwt_payload_handler = api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">jwt_encode_handler = api_settings.JWT_ENCODE_HANDLER</span><br><span class="line"></span><br><span class="line">palyload = jwt_payload_handler(user)  <span class="comment"># 把user传入 得到payload</span></span><br><span class="line">token = jwt_encode_handler(palyload)  <span class="comment"># 把payload传入 得到token</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把三段信息解析出payload 判断认证是否篡改 是否过期</span></span><br><span class="line"><span class="comment"># 通过payload转成user对象</span></span><br><span class="line">payload = jwt_decode_handler(jwt_value)</span><br></pre></td></tr></table></figure>
<h4 id="登录接口返回数据格式"><a href="#登录接口返回数据格式" class="headerlink" title="登录接口返回数据格式"></a>登录接口返回数据格式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">控制登录接口返回的数据格式</span></span><br><span class="line"><span class="string">  第一种方案：自己写登录接口</span></span><br><span class="line"><span class="string">  第二种方案：用内置</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jwt的配置响应数据格式</span></span><br><span class="line"><span class="string">&#x27;JWT_RESPONSE_PAYLOAD_HANDLER&#x27;</span>: <span class="string">&#x27;rest_framework_jwt.utils.jwt_response_payload_handler&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># jwt_response_payload_handler源码</span></span><br><span class="line"><span class="comment"># 可以重写该方法 控制返回数据的格式(返回什么 前端登录接口就能看到什么)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span>(<span class="params">token, user=<span class="literal">None</span>, request=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;token&#x27;</span>: token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;自定义控制登录jwt登录接口返回数据格式&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 1. 重写jwt_response_payload_handler方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span>(<span class="params">token, user=<span class="literal">None</span>, request=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">        <span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;登录成功&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: user.username</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置 settings.py</span></span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="comment"># &#x27;JWT_AUTH_HEADER_PREFIX&#x27;: &#x27;JWT&#x27;,  JWT自带配置 认证请求headrs需要带前缀</span></span><br><span class="line">    <span class="string">&#x27;JWT_AUTH_HEADER_PREFIX&#x27;</span>: <span class="string">&#x27;aaa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;JWT_RESPONSE_PAYLOAD_HANDLER&#x27;</span>: <span class="string">&#x27;api.utils.jwt_response_payload_handler&#x27;</span>,  <span class="comment"># JWT控制返回数据格式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>返回结果示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;token&quot;</span>: <span class="string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6Im1pbmhvIiwiZXhwIjoxNjE0ODMwNzgzLCJlbWFpbCI6Ijk3NDMxMTEwQHFxLmNvbSJ9.90l3F4oTT0gWfcgdc0LH9euZYygyWinHF4Ec-kwra-U&quot;</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;登录成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;minho&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于JWT自定制认证类"><a href="#基于JWT自定制认证类" class="headerlink" title="基于JWT自定制认证类"></a>基于JWT自定制认证类</h3><h4 id="基于BaseAuthentication"><a href="#基于BaseAuthentication" class="headerlink" title="基于BaseAuthentication"></a>基于BaseAuthentication</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span> jwt_decode_handler</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyJwtAuthentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        jwt_value = request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> jwt_value:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># jwt提供了三段token 取出用payload的方法 并且有校验功能</span></span><br><span class="line">                payload = jwt_decode_handler(jwt_value)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;签名过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户非法&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="built_in">str</span>(exc))</span><br><span class="line">            <span class="comment"># 因为payload就是用户信息字典</span></span><br><span class="line">            <span class="comment"># print(payload)</span></span><br><span class="line">            <span class="comment"># return payload, jwt_value</span></span><br><span class="line">            <span class="comment"># 需要得到user对象</span></span><br><span class="line">            <span class="comment"># 1. 去数据库查</span></span><br><span class="line">            <span class="comment"># user = models.User.objects.get(pk=payload.get(&#x27;user_id&#x27;))</span></span><br><span class="line">            <span class="comment"># 2. 不查库自己转 速度块一些</span></span><br><span class="line">            user = models.User(<span class="built_in">id</span>=payload[<span class="string">&#x27;user_id&#x27;</span>], username=payload[<span class="string">&#x27;username&#x27;</span>])</span><br><span class="line">            <span class="keyword">return</span> user, jwt_value</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 没有带认证信息 直接抛异常</span></span><br><span class="line">        <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;你没有携带认证信息&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="基于BaseJSONWebTokenAuthentication"><a href="#基于BaseJSONWebTokenAuthentication" class="headerlink" title="基于BaseJSONWebTokenAuthentication"></a>基于BaseJSONWebTokenAuthentication</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> BaseJSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span> jwt_decode_handler</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyJwtAuthentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        jwt_value = request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> jwt_value:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># jwt提供了三段token 取出用payload的方法 并且有校验功能</span></span><br><span class="line">                payload = jwt_decode_handler(jwt_value)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;签名过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户非法&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="built_in">str</span>(exc))</span><br><span class="line">            <span class="comment"># 继承BasejsonWeb 直接调用下面方法获取user对象</span></span><br><span class="line">            user = self.authenticate_credentials(payload)</span><br><span class="line">            <span class="keyword">return</span> user, jwt_value</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 没有带认证信息 直接抛异常</span></span><br><span class="line">        <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;你没有携带认证信息&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="多方式登录"><a href="#多方式登录" class="headerlink" title="多方式登录"></a>多方式登录</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用用户名 手机号 邮箱 都可以登录</span></span><br><span class="line"><span class="comment"># 前端需要传的数据格式</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;lqz/13334449988/123@qq.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># serializers.py</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.settings <span class="keyword">import</span> api_settings</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">jwt_payload_handler = api_settings.JWT_PAYLOAD_HANDLER</span><br><span class="line">jwt_encode_handler = api_settings.JWT_ENCODE_HANDLER</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginModelSerialzier</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    username = serializers.CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.User</span><br><span class="line">        fields = [<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="comment"># 在这写逻辑</span></span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)  <span class="comment"># 用户名有三种方式</span></span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="comment"># 通过判断username数据不同 查询字段不一样</span></span><br><span class="line">        <span class="comment"># 正则匹配 如果是手机号</span></span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">&#x27;^1[3-9][0-9]&#123;9&#125;$&#x27;</span>, username):</span><br><span class="line">            user = models.User.objects.<span class="built_in">filter</span>(phone=username).first()</span><br><span class="line">        <span class="keyword">elif</span> re.match(<span class="string">&#x27;^.+@.+$&#x27;</span>, username):  <span class="comment"># 邮箱</span></span><br><span class="line">            user = models.User.objects.<span class="built_in">filter</span>(email=username).first()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user = models.User.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user:  <span class="comment"># 存在用户</span></span><br><span class="line">            <span class="comment"># 校验密码 因为是密文 要用check_password</span></span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="comment"># 签发token</span></span><br><span class="line">                payload = jwt_payload_handler(user)  <span class="comment"># user传入 得到payload</span></span><br><span class="line">                token = jwt_encode_handler(payload)  <span class="comment"># payload传入 得到token</span></span><br><span class="line">                <span class="comment"># self.token = token  推荐使用context</span></span><br><span class="line">                self.context[<span class="string">&#x27;token&#x27;</span>] = token</span><br><span class="line">                self.context[<span class="string">&#x27;username&#x27;</span>] = user.username</span><br><span class="line">                <span class="keyword">return</span> attrs</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;密码错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户不存在&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ViewSet</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="comment"># class Login2View(ViewSetMixin, APIView):</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login2View</span>(<span class="params">ViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;这是登录接口&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># def post(self, request):  # 不写post 直接写login?</span></span><br><span class="line">    <span class="comment">#     pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 1. 需要有个序列化的类</span></span><br><span class="line">        <span class="comment"># 2. 生成序列化类对象</span></span><br><span class="line">        serializer = serializers.LoginModelSerialzier(data=request.data)</span><br><span class="line">        <span class="comment"># 3. 调用序列化对象的is_valid</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        token = serializer.context.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="comment"># 4. return</span></span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;status&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;token&#x27;</span>: token, <span class="string">&#x27;username&#x27;</span>: serializer.context.get(<span class="string">&#x27;username&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">path(<span class="string">&#x27;login2/&#x27;</span>, views.Login2View.as_view(&#123;<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;login&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure>
<h1 id="基于Django的权限控制"><a href="#基于Django的权限控制" class="headerlink" title="基于Django的权限控制"></a>基于Django的权限控制</h1></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kathr1neMinho</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://github.com/kathr1ne/2021/02/22/DjangoRestFramework/">https://github.com/kathr1ne/2021/02/22/DjangoRestFramework/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://github.com/kathr1ne" target="_blank">Kathr1neMinho</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">前后端分离</a><a class="post-meta__tags" href="/tags/RESTful/">RESTful</a><a class="post-meta__tags" href="/tags/API/">API</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/02/10/Django/"><img class="next-cover" src="/img/django.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Django</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/02/10/Django/" title="Django"><img class="cover" src="/img/django.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-10</div><div class="title">Django</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.JPG" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Kathr1neMinho</div><div class="author-info__description">学习笔记</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://github.com/kathr1ne"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kathr1ne" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/97431110@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RESTFramework"><span class="toc-number">1.</span> <span class="toc-text">RESTFramework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RESTful-API"><span class="toc-number">1.1.</span> <span class="toc-text">RESTful API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.2.</span> <span class="toc-text">规范</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DRF%E5%88%9D%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">DRF初识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CBV%E6%BA%90%E7%A0%81"><span class="toc-number">2.3.</span> <span class="toc-text">CBV源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#View"><span class="toc-number">2.3.1.</span> <span class="toc-text">View</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APIView"><span class="toc-number">2.3.2.</span> <span class="toc-text">APIView</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">序列化器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.1.</span> <span class="toc-text">查询一个数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">字段类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.3.</span> <span class="toc-text">字段参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.2.</span> <span class="toc-text">反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.1.</span> <span class="toc-text">修改数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.2.</span> <span class="toc-text">数据校验钩子函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E6%AE%B5%E5%A4%84%E7%90%86"><span class="toc-number">3.2.3.</span> <span class="toc-text">序列化反序列化字段处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BD%99API%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">其余API操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.1.</span> <span class="toc-text">查询所有数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.2.</span> <span class="toc-text">新增数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.3.</span> <span class="toc-text">删除数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9"><span class="toc-number">3.4.</span> <span class="toc-text">自定义响应内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E7%B1%BB%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-number">3.5.</span> <span class="toc-text">模型类序列化器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#many-True%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.6.</span> <span class="toc-text">many&#x3D;True源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serializer%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="toc-number">3.7.</span> <span class="toc-text">Serializer高级用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB%E5%AD%97%E6%AE%B5"><span class="toc-number">3.7.1.</span> <span class="toc-text">一对多关系字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB%E5%AD%97%E6%AE%B5"><span class="toc-number">3.7.2.</span> <span class="toc-text">多对多关系字段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">4.</span> <span class="toc-text">请求与响应</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Request"><span class="toc-number">4.1.</span> <span class="toc-text">Request</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#request-data"><span class="toc-number">4.1.1.</span> <span class="toc-text">request.data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requset-query-params"><span class="toc-number">4.1.2.</span> <span class="toc-text">requset.query_params</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response"><span class="toc-number">4.2.</span> <span class="toc-text">Response</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F"><span class="toc-number">4.2.1.</span> <span class="toc-text">构造方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94data"><span class="toc-number">4.2.2.</span> <span class="toc-text">响应data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94status"><span class="toc-number">4.2.3.</span> <span class="toc-text">响应status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94template-name"><span class="toc-number">4.2.4.</span> <span class="toc-text">响应template_name</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94headers"><span class="toc-number">4.2.5.</span> <span class="toc-text">响应headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94content-type"><span class="toc-number">4.2.6.</span> <span class="toc-text">响应content_type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Response%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.3.</span> <span class="toc-text">封装Response对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%AE%B6%E6%97%8F"><span class="toc-number">5.</span> <span class="toc-text">视图家族</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%9B%BE%E5%9F%BA%E7%B1%BB"><span class="toc-number">5.1.</span> <span class="toc-text">两个视图基类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#APIView-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">APIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GenericAPIVIew"><span class="toc-number">5.1.2.</span> <span class="toc-text">GenericAPIVIew</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E4%B8%AA%E8%A7%86%E5%9B%BE%E6%89%A9%E5%B1%95Mixin%E7%B1%BB"><span class="toc-number">5.2.</span> <span class="toc-text">五个视图扩展Mixin类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ListModelMixin"><span class="toc-number">5.2.1.</span> <span class="toc-text">ListModelMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateModelMixin"><span class="toc-number">5.2.2.</span> <span class="toc-text">CreateModelMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RetrieveModelMixin"><span class="toc-number">5.2.3.</span> <span class="toc-text">RetrieveModelMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UpdateModelMixin"><span class="toc-number">5.2.4.</span> <span class="toc-text">UpdateModelMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DestroyModelMixin"><span class="toc-number">5.2.5.</span> <span class="toc-text">DestroyModelMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mixin%E7%B1%BB%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.6.</span> <span class="toc-text">Mixin类使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E4%B8%AA%E9%80%9A%E7%94%A8%E8%A7%86%E5%9B%BE%E5%AD%90%E7%B1%BB"><span class="toc-number">5.3.</span> <span class="toc-text">九个通用视图子类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateAPIView"><span class="toc-number">5.3.1.</span> <span class="toc-text">CreateAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ListAPIView"><span class="toc-number">5.3.2.</span> <span class="toc-text">ListAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RetrieveAPIView"><span class="toc-number">5.3.3.</span> <span class="toc-text">RetrieveAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DestroyAPIView"><span class="toc-number">5.3.4.</span> <span class="toc-text">DestroyAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UpdateAPIView"><span class="toc-number">5.3.5.</span> <span class="toc-text">UpdateAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ListCreateAPIView"><span class="toc-number">5.3.6.</span> <span class="toc-text">ListCreateAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RetrieveUpdateAPIView"><span class="toc-number">5.3.7.</span> <span class="toc-text">RetrieveUpdateAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RetrieveDestroyAPIView"><span class="toc-number">5.3.8.</span> <span class="toc-text">RetrieveDestroyAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RetrieveUpdateDestroyAPIView"><span class="toc-number">5.3.9.</span> <span class="toc-text">RetrieveUpdateDestroyAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E8%A7%86%E5%9B%BE%E5%AD%90%E7%B1%BB%E4%BD%BF%E7%94%A8"><span class="toc-number">5.3.10.</span> <span class="toc-text">通用视图子类使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E9%9B%86ViewSet"><span class="toc-number">5.4.</span> <span class="toc-text">视图集ViewSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ModelViewSet"><span class="toc-number">5.4.1.</span> <span class="toc-text">ModelViewSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewSetMixin%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">5.4.2.</span> <span class="toc-text">ViewSetMixin源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFViewSetMixin%E7%9A%84%E8%A7%86%E5%9B%BE%E7%B1%BB"><span class="toc-number">5.4.3.</span> <span class="toc-text">继承ViewSetMixin的视图类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ViewSet"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">ViewSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GenericViewSet"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">GenericViewSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadOnlyModelViewSet"><span class="toc-number">5.4.3.3.</span> <span class="toc-text">ReadOnlyModelViewSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ModelViewSet-1"><span class="toc-number">5.4.3.4.</span> <span class="toc-text">ModelViewSet</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1Routers"><span class="toc-number">6.</span> <span class="toc-text">路由Routers</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%86%99%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">简单写法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FBV"><span class="toc-number">6.1.1.</span> <span class="toc-text">FBV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CBV"><span class="toc-number">6.1.2.</span> <span class="toc-text">CBV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewSetMixin"><span class="toc-number">6.1.3.</span> <span class="toc-text">ViewSetMixin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Routers"><span class="toc-number">6.2.</span> <span class="toc-text">Routers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleRouter%E5%92%8CDefaultRouter"><span class="toc-number">6.2.1.</span> <span class="toc-text">SimpleRouter和DefaultRouter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#action%E4%BD%BF%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">action使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%BB%84%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">认证组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%B1%BB%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-number">7.1.</span> <span class="toc-text">认证类的写法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">7.2.</span> <span class="toc-text">认证源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E7%B1%BB"><span class="toc-number">7.3.</span> <span class="toc-text">自定义认证类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.3.1.</span> <span class="toc-text">简单登录实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E7%B1%BB"><span class="toc-number">7.3.2.</span> <span class="toc-text">实现自定义认证类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E8%AE%A4%E8%AF%81%E7%B1%BB"><span class="toc-number">7.4.</span> <span class="toc-text">内置认证类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BasicAuthentication"><span class="toc-number">7.4.1.</span> <span class="toc-text">BasicAuthentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoteUserAuthentication"><span class="toc-number">7.4.2.</span> <span class="toc-text">RemoteUserAuthentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SessionAuthentication"><span class="toc-number">7.4.3.</span> <span class="toc-text">SessionAuthentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TokenAuthentication"><span class="toc-number">7.4.4.</span> <span class="toc-text">TokenAuthentication</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%84%E4%BB%B6"><span class="toc-number">8.</span> <span class="toc-text">权限组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">8.1.</span> <span class="toc-text">权限源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90%E7%B1%BB"><span class="toc-number">8.2.</span> <span class="toc-text">自定义权限类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%9D%83%E9%99%90%E7%B1%BB"><span class="toc-number">8.3.</span> <span class="toc-text">内置权限类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IsAdminUser"><span class="toc-number">8.3.1.</span> <span class="toc-text">IsAdminUser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IsAuthenticated"><span class="toc-number">8.3.2.</span> <span class="toc-text">IsAuthenticated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IsAuthenticatedOrReadOnly"><span class="toc-number">8.3.3.</span> <span class="toc-text">IsAuthenticatedOrReadOnly</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%91%E7%8E%87%E7%BB%84%E4%BB%B6"><span class="toc-number">9.</span> <span class="toc-text">频率组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89IP%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6%E7%B1%BB"><span class="toc-number">9.1.</span> <span class="toc-text">自定义IP频率限制类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFBaseThrottle"><span class="toc-number">9.1.1.</span> <span class="toc-text">继承BaseThrottle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFSimpleRateThrottle"><span class="toc-number">9.1.2.</span> <span class="toc-text">继承SimpleRateThrottle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%9A%84%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6"><span class="toc-number">9.2.</span> <span class="toc-text">内置的频率限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AnonRateThrottle"><span class="toc-number">9.2.1.</span> <span class="toc-text">AnonRateThrottle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserRateThrottle"><span class="toc-number">9.2.2.</span> <span class="toc-text">UserRateThrottle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ScopedRateThrottle"><span class="toc-number">9.2.3.</span> <span class="toc-text">ScopedRateThrottle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E7%BB%84%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text">解析组件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4"><span class="toc-number">11.</span> <span class="toc-text">过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4django-filter"><span class="toc-number">11.1.</span> <span class="toc-text">过滤django-filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E5%BA%8FOrderingFilter"><span class="toc-number">11.2.</span> <span class="toc-text">排序OrderingFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2SearchFilter"><span class="toc-number">11.3.</span> <span class="toc-text">搜索SearchFilter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81"><span class="toc-number">12.1.</span> <span class="toc-text">异常处理部分源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-number">12.2.</span> <span class="toc-text">自定义异常处理方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%A6%E7%B1%8D%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E8%AF%A6%E7%BB%86"><span class="toc-number">13.</span> <span class="toc-text">书籍管理接口详细</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="toc-number">13.1.</span> <span class="toc-text">模型类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CBV%E8%A7%86%E5%9B%BE"><span class="toc-number">13.2.</span> <span class="toc-text">CBV视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8-1"><span class="toc-number">13.3.</span> <span class="toc-text">序列化器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96-1"><span class="toc-number">13.3.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-1"><span class="toc-number">13.3.2.</span> <span class="toc-text">反序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">13.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%99%A8"><span class="toc-number">14.</span> <span class="toc-text">分页器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PageNumberPagination"><span class="toc-number">14.1.</span> <span class="toc-text">PageNumberPagination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LimitOffsetPagination"><span class="toc-number">14.2.</span> <span class="toc-text">LimitOffsetPagination</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CursorPagination"><span class="toc-number">14.3.</span> <span class="toc-text">CursorPagination</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-number">15.</span> <span class="toc-text">自动生成接口文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85coreapi"><span class="toc-number">15.1.</span> <span class="toc-text">安装coreapi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">15.2.</span> <span class="toc-text">路由配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%8F%8F%E8%BF%B0%E8%AF%B4%E6%98%8E%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%8D%E7%BD%AE"><span class="toc-number">15.3.</span> <span class="toc-text">文档描述说明的定义位置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%80%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">15.3.1.</span> <span class="toc-text">单一方法的视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">15.3.2.</span> <span class="toc-text">多个方法的视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E9%9B%86ViewSet-1"><span class="toc-number">15.3.3.</span> <span class="toc-text">视图集ViewSet</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT%E8%AE%A4%E8%AF%81"><span class="toc-number">16.</span> <span class="toc-text">JWT认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">16.1.</span> <span class="toc-text">JWT数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">16.1.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload"><span class="toc-number">16.1.2.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Signature"><span class="toc-number">16.1.3.</span> <span class="toc-text">Signature</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Base64URL"><span class="toc-number">16.1.4.</span> <span class="toc-text">Base64URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C"><span class="toc-number">16.1.5.</span> <span class="toc-text">检验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DRF%E9%A1%B9%E7%9B%AE%E7%9A%84JWT%E8%AE%A4%E8%AF%81%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">16.2.</span> <span class="toc-text">DRF项目的JWT认证开发流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9JWT%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">16.2.1.</span> <span class="toc-text">第三方JWT的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFDjangoUser%E8%A1%A8%E6%89%A9%E5%B1%95"><span class="toc-number">16.2.1.1.</span> <span class="toc-text">继承DjangoUser表扩展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">16.2.1.2.</span> <span class="toc-text">登录认证简单使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E5%88%B6JWT%E8%AE%A4%E8%AF%81%E5%8E%BB%E9%99%A4headers%E5%89%8D%E7%BC%80"><span class="toc-number">16.2.1.3.</span> <span class="toc-text">自定制JWT认证去除headers前缀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E7%AD%BE%E5%8F%91JWT"><span class="toc-number">16.2.1.4.</span> <span class="toc-text">手动签发JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">16.2.1.5.</span> <span class="toc-text">登录接口返回数据格式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJWT%E8%87%AA%E5%AE%9A%E5%88%B6%E8%AE%A4%E8%AF%81%E7%B1%BB"><span class="toc-number">16.2.2.</span> <span class="toc-text">基于JWT自定制认证类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EBaseAuthentication"><span class="toc-number">16.2.2.1.</span> <span class="toc-text">基于BaseAuthentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EBaseJSONWebTokenAuthentication"><span class="toc-number">16.2.2.2.</span> <span class="toc-text">基于BaseJSONWebTokenAuthentication</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%B9%E5%BC%8F%E7%99%BB%E5%BD%95"><span class="toc-number">16.2.3.</span> <span class="toc-text">多方式登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EDjango%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-number">17.</span> <span class="toc-text">基于Django的权限控制</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/02/22/DjangoRestFramework/" title="DjangoRESTframework"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DjangoRESTframework"/></a><div class="content"><a class="title" href="/2021/02/22/DjangoRestFramework/" title="DjangoRESTframework">DjangoRESTframework</a><time datetime="2021-02-22T15:00:00.000Z" title="发表于 2021-02-22 23:00:00">2021-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/10/Django/" title="Django"><img src="/img/django.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Django"/></a><div class="content"><a class="title" href="/2021/02/10/Django/" title="Django">Django</a><time datetime="2021-02-10T14:00:00.000Z" title="发表于 2021-02-10 22:00:00">2021-02-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Kathr1neMinho</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>